window.qst=window.qst||{},window.qst=_.extend(window.qst,{language:_.getCookie("lang")||(navigator.language||navigator.systemLanguage||navigator.browserLanguage||navigator.userLanguage||"en").substr(0,2).toLowerCase(),root:"http://localhost:3007",l10n:{},preloadTemplates:function(){if(window.qst_dev){var a=[];return _.each(window.templates.files,function(b){var c=window.templates.path+"/"+b+"."+window.templates.ext;a.push($.get(c,function(a){qst.Templates.add(b,a)}))}),a}return[]},init:function(){"en"!==this.language&&"ru"!==this.language&&"ko"!==this.language&&"ja"!==this.language&&"zh"!==this.language&&(this.language="en"),$.when.apply(this,this.preloadTemplates()).done(function(){qst.app=new qst.App({debug:!0}),Backbone.history.start({pushState:!0})}),$(document).on("click","a",function(a){if(a.metaKey||a.ctrlKey)return!0;var b=$(this);return b.attr("target")?!0:(a.stopPropagation(),a.preventDefault(),"event"==b.attr("type")?qst.trigger(b.attr("href")):(qst.app.router.context=b.data(),qst.app.router.navigate(b.attr("href"),{trigger:!0})),!1)})},log:function(a){console.log(a)},error:function(a){console.error(a)},navigate:function(a,b){b&&b.trigger===!1&&(qst.app.statistic.trackCurrentPageChange(),qst.app.trigger("need:meta:update")),qst.app.router.navigate(a,b)},is_needauth:function(){return qst.is_authed()?!1:(qst.trigger("auth:show"),!0)},is_authed:function(){return!!qst.user&&qst.user.is_auth()},authUrl:function(a){var b={};return qst.app&&qst.app.user.get("uid")?(b={uid:qst.app.user.get("uid"),token:qst.app.user.get("token")},-1==a.indexOf("?")&&(a+="?"),a+_.map(b,function(a,b){return b+"="+a}).join("&")):a},warning:function(a,b){new qst.WarningView({content:qst.localize(a,b)})},localize:function(a,b){return Handlebars.helpers._(a,b).toString()},speedScrollTop:function(a,b){$("html, body").animate({scrollTop:a||0},b||300)},isLink:function(a){return!qst.isFile(a)},isFile:function(a){return a=a||"",-1!==a.indexOf("qstoq.ru")}}),window.qst.Templates=window.qst.Templates||{},window.qst.Templates=_.extend(window.qst.Templates,{templates:{},compiled:{},add:function(a,b){this.templates[a]=b},get:function(a){if(window.qst_dev)return this.compiled[a]?this.templates[a]:this.templates[a]?(this.templates[a]=Handlebars.compile(this.templates[a]),this.compiled[a]=!0,this.templates[a]):(console.error("Can't find template \""+a+'"'),function(){return""});if(this.ptemplates){var b=this.ptemplates[a];return b?b:(console.error("Can't find template \""+a+'"'),function(){return""})}return console.error("Can't find templates at all"),function(){return""}}}),Backbone._sync=Backbone.sync,Backbone.sync=function(a,b,c){c=c||{};var d={};return c.userData?d={token:c.userData.token}:qst.app&&qst.app.user.get("uid")&&(d={token:qst.app.user.get("token")}),c.url=(c.url||b.url&&_.result(b,"url"))+"?"+_.map(d,function(a,b){return b+"="+a}).join("&"),Backbone._sync(a,b,c)},$(document).ready(function(){_.extend(qst,Backbone.Events),qst.init()}),qst.LazyLoader=Backbone.Model.extend({onImageLoad:function(){var a=$(this);a.parents(".load-bg").toggleClass("img-loaded",!0),a.data("bg")?a.css({"background-image":"url("+a.data("orig")+")"}):a.attr("src",a.data("orig"))},onImageError:function(){this.trigger("load:error")},load:function(a){var b=a.find("img.lazy"),c=this;_.forEach(b,function(a){var b=$(a),d=new Image;d.src=b.data("orig"),d.onload=_.bind(c.onImageLoad,b),d.onerror=_.bind(c.onImageError,c)})}}),qst.Page=Backbone.Model.extend({initialize:function(a){a.template||this.trigger("error",{message:"Page must have a template"}),this.view=new qst.PageView({model:this,template:a.template}),this.view.on("render",function(){this.collection.trigger("render")}),this.get("view")&&(this.pageView=this.get("model")?new(qst[this.get("view")])({model:this.get("model")}):new(qst[this.get("view")])),this.get("model")&&(this.pageModel=new(qst[this.get("model")]))},render:function(){this.view&&this.view.render&&this.view.render()},remove:function(){this.view.remove()},enterDocument:function(){}}),qst.PageView=Backbone.View.extend({el:"#qst-container",template:"",renderedHtml:null,initialize:function(a){return a&&a.template?(this.template=qst.Templates.get(a.template),this.createDom(),void 0):(qst.error("Page must have a template"),void 0)},createDom:function(){},render:function(){if(this.renderedHtml)this.$el.append(this.renderedHtml);else{var a=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.template(this.model.toJSON()));this.trigger("page:preRender",a),this.$el.html(a)}$("body").attr("class","body__page-"+this.model.get("name")),this.model.enterDocument(),this.trigger("page:render",this.model),this.trigger("enterDocument",this.model)},remove:function(){console.log("page remove"),this.renderedHtml=this.$el.find(".page-"+this.model.get("name")).detach()}}),qst.PagesCollection=Backbone.Collection.extend({initialize:function(){},getPage:function(a){var b=this.find(function(b){return b.get("name")==a});return b||this.first()},havePage:function(a){return this.any(function(b){return b.get("name")==a})}}),qst.PopupView=Backbone.View.extend({template:"popups/popup",className:"popup",events:{"click .popup__previous":"previous","click .popup__close":"hide","click .popup__td":"bgClick"},options:{},defaults:{content:"","class":"",width:""},_rendered:!1,initialize:function(){this.template=qst.Templates.get(this.template),_.defaults(this.options,this.defaults),this.on("popup:show",function(){this.trigger("show")},this),this.on("popup:hide",function(){this.trigger("hide")},this)},render:function(){if(this._rendered)return this.$el;var a=this.options.content;return(_.isObject(a)||!a)&&(this.options.content="<div id='placeholder"+this.cid+"'>"),this.$el.append(this.template(this.options)),this.setContent(a),this._rendered=!0,this.$el.on("scroll.popup",function(a){var b=$(a.currentTarget),c=b.find(".popup__table");b.scrollTop()+150>=c.height()-b.height()&&qst.trigger("popupbottom:reached")}),this.$el},lockPage:function(){$("body").css("overflow","hidden")},unlockPage:function(){$("body").css("overflow","auto")},bgClick:function(a){a&&a.target&&"popup__td"==a.target.className&&this.hide()},reactKeypress:function(a){if(27==a.keyCode){var b=$(a.srcElement);b.is(":input")||this.hide()}},showPopup:function(){var a=$(document.body);a.append(this.render()),this.lockPage(),this.trigger("popup:show"),$(document).on("keyup.popup",_.bind(this.reactKeypress,this))},hidePopup:function(){this.$el.off("scroll.popup"),this.$el.detach(),this.trigger("popup:hide"),$(document).off("keyup.popup")},show:function(){this.showPopup()},hide:function(){return this.hidePopup(),this.unlockPage(),!1},previous:function(){this.trigger("previous")},scroll:function(a){this.$el.animate({scrollTop:a},200)},setContent:function(a){a&&(this.options.content=a,this._rendered?this.$el.find(".popup__content").empty().append(a):this.$el.find("#placeholder"+this.cid).replaceWith(a))},setWidth:function(a){a&&(this.options.width=a,this.$el.find(".popup__inner").toggleClass().addClass("popup__inner").addClass("span"+a))}}),qst.WarningView=Backbone.View.extend({template:"popups/warning",className:"warning",events:{"click .warning__close":"close"},options:{content:":("},initialize:function(a){this.options=a,this.template=qst.Templates.get(this.template),this.popup_view=new qst.PopupView({"class":"warning-popup"}),this.popup_view.on("hide",this.clear,this),this.render()},render:function(){return this.$el.append(this.template(this.options)),this.popup_view.setContent(this.$el),this.popup_view.show(),this.$el},close:function(){return this.popup_view.hide(),!1},clear:function(){return this.popup_view.remove(),this.remove(),!1}}),qst.Confirm=Backbone.Model.extend({url:"/",defaults:{url:"/",data:{},method:"post",event:"",eventdata:"",content:"?",ok_title:"Ok",close_title:"Cancel",success_title:"Allset",error_title:"Something went wrong...",backreload:!1},initialize:function(a){a&&a.url&&(this.url=a.url),this.view=new qst.ConfirmView({model:this})},fetch:function(a){return a=a||{},a.type=this.get("method"),a.data=this.get("data"),a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),b.error?this.trigger("confirm:error"):(this.trigger("confirm:success"),this.get("event")&&(console.log(this.get("event"),this.get("eventdata")),this.get("eventdata")&&!_.isEmpty(_.toJSON(this.get("eventdata")))?qst.trigger(this.get("event"),_.toJSON(this.get("eventdata"))):qst.trigger(this.get("event"))))},error:function(){this.trigger("confirm:error")}}),qst.ConfirmView=Backbone.View.extend({template:"popups/confirm",className:"confirm",events:{"click .confirm__close":"close","click .confirm__ok":"confirm"},initialize:function(){this.template=qst.Templates.get(this.template),this.popup_view=new qst.PopupView({"class":"confirm-popup"}),this.model.on("load:start",this.confirmStart,this),this.model.on("confirm:success",this.confirmSuccess,this),this.model.on("confirm:error",this.confirmError,this),this.popup_view.on("hide",this.clear,this),this.render()},render:function(){return this.$el.append(this.template(this.model.toJSON())),this.popup_view.setContent(this.$el),this.popup_view.show(),this.$el},confirm:function(){return this.model.fetch(),!1},confirmStart:function(){return this.$el.toggleClass("confirm_loading",!0).toggleClass("confirm_success",!1).toggleClass("confirm_error",!1),!1},confirmSuccess:function(){return this.$el.toggleClass("confirm_loading",!1).toggleClass("confirm_success",!0).toggleClass("confirm_error",!1),this.model.get("backreload")&&setTimeout(_.bind(function(){qst.trigger("historyback:reload"),this.clear()},this),1e3),!1},confirmError:function(){return this.$el.toggleClass("confirm_loading",!1).toggleClass("confirm_success",!1).toggleClass("confirm_error",!0),setTimeout(_.bind(function(){this.$el.toggleClass("confirm_error",!1)},this),2500),!1},close:function(){return this.popup_view.hide(),!1},clear:function(){return this.popup_view.remove(),this.remove(),this.model.clear({silent:!0}),!1}}),qst.UserSettings=Backbone.Model.extend({url:"/v1/users/",defaults:{geo_position:null},fetch:function(a){return a=a||{},a.type="get",a.data=a.data||{token:_.getCookie("token")},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){var b=_.toJSON(b);b.success&&b.result.user?(this.set(b.result.user),this.trigger("usersettings:ready",b.result.user)):this.trigger("error",{description:"WHP/auth : check state ERROR after netcall!"})},error:function(){this.trigger("error",{description:"WHP/auth : check state ERROR self!"})},getGeoPosition:function(){this.get("geo_position")||(navigator.geolocation?navigator.geolocation.getCurrentPosition(_.bind(this.getGeoSuccess,this),_.bind(this.getGeoError,this)):error("not supported"))},getGeoSuccess:function(a){this.set("geo_position",a)},getGeoError:function(a){qst.error(a)}}),qst.User=Backbone.Model.extend({cookie_time:365,defaults:{status:"",uid:"",token:""},settings:null,initialize:function(){this.settings=new qst.UserSettings,this.settings.getGeoPosition(),this.settings.on("error",function(a){this.trigger("user:error",a)},this),this.on("change:token",function(){this.settings.fetch()},this),this.getSession(),qst.on("auth:success",this.setSession,this),qst.on("auth:clear",this.clearSession,this)},getSession:function(){var a=_.getCookie("uid"),b=_.getCookie("token");a&&b&&this.set({uid:a,token:b})},is_auth:function(){return!!this.get("token")},setSession:function(a){_.setCookie("uid",a.session.uid,this.cookie_time),_.setCookie("token",a.session.token,this.cookie_time),this.set(a.session)},clearSession:function(){_.clearCookie("uid"),_.clearCookie("token"),this.set({uid:"",token:""})}}),qst.Registration=Backbone.Model.extend({url:"/api/auth/signup/",initialize:function(){},fetch:function(a){var b=this;this.set(a),$.ajax({type:"POST",url:_.toSafeUrl(this.url),dataType:"json",data:{login:a.login,passw:a.password,first_name:a.first_name,last_name:a.last_name}}).success(function(a,c,d){b.success(a,c,d)}).error(function(a,c,d){b.error(a,c,d)})},success:function(a){var b=_.toJSON(a);b?b.error?"API_AlreadyInUse"==b.error.code?this.trigger("error",{type:"login",description:"This email already registered"}):"API_BadParams"==b.error.code?this.trigger("error",{description:"Enter your first and last name"}):"API_PendingConfirmation"==b.error.code?this.trigger("error",{description:"We have sent you an e-mail to confirm"}):this.trigger("error",{description:"Something went wrong"}):b.state&&"PENDING_CONFIRMATION"==b.state?this.trigger("registration:pending",{login:this.get("login")}):(this.trigger("auth:success",{response:b,user:b.user,session:{token:b.user.token,uid:b.user.id}}),this.trigger("registration:success")):this.trigger("error",{description:"Something went wrong"})},error:function(){this.trigger("error",{description:"Something went wrong"})}}),qst.Signin=Backbone.Model.extend({url:"/v1/auth",initialize:function(){},login:function(a){return this.fetch(a),!1},fetch:function(a){var b=this;$.ajax({type:"post",url:this.url,dataType:"json",data:{email:a.login,password:a.password}}).success(function(a,c,d){b.success(a,c,d)}).error(function(a,c,d){b.error(a,c,d)})},success:function(a){var b=_.toJSON(a);b&&(b.success?this.trigger("auth:success",{response:b.result,user:b.result.user,session:{token:b.result.token,uid:b.result.user.id}}):this.error())},error:function(){this.trigger("error",{description:"Something went wrong"})}}),qst.TW=Backbone.Model.extend({url_token:"/api/auth/twitter/request_token/",url:"/api/auth/",inited:!1,req_count:0,req_max:5,curWind:null,loading:!1,oauth_token:0,initialize:function(){var a,b=document.getElementsByTagName("script")[0];document.getElementById("twitter-jssdk")||(a=document.createElement("script"),a.id="twitter-jssdk",$(a).load(function(){}),a.src="//platform.twitter.com/widgets.js",b.parentNode.insertBefore(a,b),this.inited=!0,this.on("error",function(a){console.error(a)},this),qst.is_authed()||(this.req_count=0,this.fetchToken()))},login:function(){return qst.log("login tw >"),this.loading||(this.curWind=_.openWindow2("Twitter auth",640,480),this.curWind.location.href="http://api.twitter.com/oauth/authorize?oauth_token="+this.oauth_token),!1},fetchToken:function(){this.req_count>this.req_max&&this.trigger("error",{description:"too many token request to "+this.url_token}),this.loading=!0;var a=this;$.ajax({type:"GET",url:_.toSafeUrl(this.url_token),dataType:"json"}).success(function(b,c,d){a.successToken(b,c,d)}).error(function(b,c,d){a.errorToken(b,c,d)})},successToken:function(a){var b=_.toJSON(a);this.req_count++,b.error?this.trigger("error",{description:"WHP/auth/TW : got error while getting twitter token = ["+b.error.code+"]"}):(this.oauth_token=b.oauth_token,this.loading=!1,qst.log("WHP/auth/TW : get twitter request token = ["+b.oauth_token+"]"),this.req_count=0)},errorToken:function(a,b){this.req_count++,this.trigger("error",{description:"WHP/auth/TW : error while logging in!"});var b=a.status;console.log(a),0==b?this.trigger("error",{description:"WHP/auth/TW : OFFLINE mode!"}):this.trigger("error",{description:"WHP/auth/TW : error while getting twitter request token! Status = ["+b+"] Tries = ["+this.req_count+"]"}),this.fetchToken()},fetch:function(a){qst.log("GET TW AUTH = ["+a.uid+" : "+a.token+" : "+a.secret+"]"),qst.log("WHP/auth/TW : get auth...");var b=this;$.ajax({type:"GET",url:_.toSafeUrl(this.url),dataType:"json",data:{social:"tw",access_token:a.token,access_token_secret:a.secret}}).success(function(a,c,d){b.success(a,c,d)}).error(function(a,c,d){b.error(a,c,d)})},success:function(a){var b=_.toJSON(a);b.error?"API_AuthFailed"==b.error.code?this.trigger("error",{description:"This account isn't linked with WeHeartPics"}):this.trigger("error",{description:"Something went wrong"}):this.trigger("auth:success",{response:b,user:b.user,session:{token:b.user.token,uid:b.user.id}})},error:function(){this.trigger("error",{description:"WHP/auth/TW : error while logging in!"})}}),qst.VK=Backbone.Model.extend({url:"/v1/auth/vk",inited:!1,wind:null,app_id:3836385,redirect_url:qst.root+"/go/close_vk.html",initialize:function(){},login:function(){return this.wind=_.openWindow2("VK auth",640,480),this.wind.location.href="http://oauth.vk.com/authorize?client_id="+this.app_id+"&scope=photos,offline&response_type=token&display=popup&redirect_uri="+this.redirect_url,!1},fetch:function(a){var b=this;$.ajax({type:"post",url:this.url,dataType:"json",data:{vkAccessToken:a.token,vkUserId:a.uid}}).success(function(a,c,d){b.success(a,c,d)}).error(function(a){b.error(a)})},success:function(a){var b=_.toJSON(a);b&&b.success?this.trigger("auth:success",{response:b.result,user:b.result.user,session:{token:b.result.token,uid:b.result.user.id}}):this.error()},error:function(){qst.log("WHP/auth/VK : error while logging in!"),this.trigger("error",{description:"Something went wrong"})}}),qst.FB=Backbone.Model.extend({url:"/v1/auth/fb",app_id:"137692866413480",inited:!1,access_token:null,access_uid:null,initialize:function(){window.fbAsyncInit=_.bind(function(){FB.init({appId:this.app_id,cookie:!0,status:!0,xfbml:!0,oauth:!1}),FB.Event.subscribe("edge.create",this.fbShareEvents),_.browser.opera&&(FB.XD._transport="postmessage",FB.XD.PostMessage.init()),FB.getLoginStatus(_.bind(function(a){"connected"==a.status?qst.log("Facebook : user was succesfully connected! :)"):qst.log("Facebook : user was not connected! :(")},this))},this),function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/all.js#xfbml=1",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk"),this.inited=!0},fetch:function(){if(null!=this.access_token){var a=this;$.ajax({type:"post",url:this.url,data:{fbUserId:this.access_uid,fbAccessToken:this.access_token},dataType:"json"}).success(function(b,c,d){a.success(b,c,d)}).error(function(b){a.error(b)})}},success:function(a){var b=_.toJSON(a);b&&b.success?this.trigger("auth:success",{response:b.result,user:b.result.user,session:{token:b.result.token,uid:b.result.user.id}}):this.error()},error:function(){qst.log("WHP/auth/FB : error while logging in!"),this.trigger("error",{description:"WHP/auth/FB : error while logging in!"})},login:function(){return this.access_token="",FB.login(_.bind(this.onFBData,this),{scope:"publish_actions,publish_stream,user_photos,offline_access,email,user_birthday"}),!1},loginOG:function(a,b){this.access_token="",FB.login(b,{scope:"publish_actions,publish_stream,user_photos,offline_access,email,user_birthday"})},fbShareEvents:function(a){qst.log("CreateEdge"),this.trigger("fb:like",a)},onFBData:function(a){if("connected"==a.status){qst.log("Facebook : user was succesfully connected! :)",a.authResponse);var b=a.authResponse.userID,c=a.authResponse.accessToken;this.access_token!=c?(qst.log("Facebook : token = ["+c+"]"),this.access_uid=b,this.access_token=c,this.fetch()):qst.log("Facebook : user was not connected! :(")}}}),qst.AuthView=Backbone.View.extend({el:".auth-popup",template:"popups/auth",rendered:!1,events:{"click .auth-popup_close":"hide","click .auth-popup__login-email_forgot":"toReset","keypress :input":"errorInputUnmark","click :input":"errorInputUnmark","click .login-via-fb":"loginFB","click .login-via-tw":"loginTW","click .login-via-vk":"loginVK","click .login-via-email":"showLoginByEmailForm","click .auth-popup__login-email_back":"hideLoginByEmailForm","click .auth-popup__login-email_ok":"postSigninForm","submit .auth-popup__login-email>form":"postSigninForm","keyup #login-email":"switchPostButton","keyup #login-password":"switchForgotPassword","keyup #registration-email0":"errorRegistrationHide","keyup #registration-password0":"errorRegistrationHide","click 	.auth-popup__registration_next":"registrationNext","submit .auth-popup__registration>form":"registrationNext","click 	.auth-popup__registration_back":"hideRegistrationStep2Form","keyup #registration-first_name0":"errorRegistrationStep2Hide","keyup #registration-last_name0":"errorRegistrationStep2Hide","click 	.auth-popup__registration_ok":"postRegistrationForm","submit .auth-popup__registration-names>form":"postRegistrationForm"},initialize:function(){this.template=qst.Templates.get(this.template)},render:function(){this.rendered||(this.rendered=!0,this.$el.append(this.template(this.model.toJSON())),this.$login_email_container=this.$el.find(".auth-popup__login-email"),this.$login_email_form=this.$el.find(".auth-popup__login-email form"),this.$login_email_forget=this.$el.find(".auth-popup__login-email_forgot"),this.$login_email_ok=this.$el.find(".auth-popup__login-email_ok"),this.$login_email=this.$login_email_form.find("#login-email"),this.$login_password=this.$login_email_form.find("#login-password"),this.$login_error=this.$el.find(".auth-popup__login-error"),this.on("error:signin",this.errorSignin,this),this.model.signin.on("error",this.errorSignin,this),this.$registration_form=this.$el.find(".auth-popup__registration form"),this.$registration_email=this.$registration_form.find("#registration-email0"),this.$registration_password=this.$registration_form.find("#registration-password0"),this.$registration_error=this.$el.find(".auth-popup__registration-error"),this.$registration_step2_container=this.$el.find(".auth-popup__registration-names"),this.$registration_step2_form=this.$el.find(".auth-popup__registration-names form"),this.$registration_first_name=this.$registration_step2_form.find("#registration-first_name0"),this.$registration_last_name=this.$registration_step2_form.find("#registration-last_name0"),this.$registration_step2_error=this.$el.find(".auth-popup__registration-names-error"),this.on("error:registration",this.errorRegistration,this),this.on("error:registration:step2",this.errorRegistrationStep2,this),this.model.registration.on("error",this.errorRegistrationStep2,this),this.model.on("auth:success",this.hide,this),this.model.registration.on("registration:pending",this.hide,this),this.model.on("auth:show",this.show,this))},show:function(a){return this.$el.toggleClass("hide",!1),a&&a.email&&(this.$registration_email.val(a.email),this.$registration_email.focus()),!1},toReset:function(){return this.hide(),qst.navigate("/reset",{trigger:!0}),!1},hide:function(){return this.$el.toggleClass("hide",!0),this.clear(),!1},clear:function(){this.$login_email.val(""),this.$login_password.val(""),this.$registration_email.val(""),this.$registration_password.val(""),this.$registration_first_name.val(""),this.$registration_last_name.val(""),this.switchForgotPassword(),this.hideLoginByEmailForm(),this.switchPostButton(),this.hideRegistrationStep2Form(),this.errorSigninHide(),this.errorRegistrationHide()},loginFB:function(){return this.model.FB.login(event),!1},loginTW:function(){return this.model.TW.login(event),!1},loginVK:function(){return this.model.VK.login(event),!1},showLoginByEmailForm:function(){return this.$login_email_container.fadeIn(),this.$login_email.focus(),_.isEmpty(this.$login_email.val())||this.switchPostButton({target:{value:"hack"}}),!1},hideLoginByEmailForm:function(){return this.$login_email_container.fadeOut(),!1},switchForgotPassword:function(a){this.errorSigninHide(a),a&&a.target.value?this.$login_email_forget.fadeIn():this.$login_email_forget.fadeOut()},switchPostButton:function(a){this.errorSigninHide(a),a&&a.target.value?this.$login_email_ok.fadeIn():this.$login_email_ok.fadeOut()},postSigninForm:function(a){a.preventDefault(),a.stopPropagation();var b=this.$login_email.val(),c=this.$login_password.val();return _.isEmail(b)?c?this.model.signin.login({login:b,password:c}):this.trigger("error:signin",{type:"password",description:qst.localize("Do you have an empty password?","auth")}):this.trigger("error:signin",{type:"login",description:qst.localize("Doesn#39;t look like a valid email!","auth")}),!1},errorSignin:function(a){"password"==a.type?this.$login_password.focus():this.$login_email.focus(),this.$login_error.html(a.description),this.$login_error.fadeIn()},errorSigninHide:function(a){return a&&a.keyCode&&13==a.keyCode?!1:(this.$login_error.hide(),!1)},registrationNext:function(a){a.preventDefault(),a.stopPropagation();var b=this.$registration_email.val(),c=this.$registration_password.val();return _.isEmail(b)?c.length<6?this.trigger("error:registration",{type:"password",description:qst.localize("Please use at least 6 characters","auth")}):c.length>16?this.trigger("error:registration",{type:"password",description:qst.localize("You can&#39;t use more than 16 characters","auth")}):this.showRegistrationStep2Form():this.trigger("error:registration",{type:"login",description:qst.localize("Doesn&#39;t look like a valid email!","auth")}),!1},showRegistrationStep2Form:function(){return this.$registration_step2_container.fadeIn(),this.$registration_first_name.focus(),!1},hideRegistrationStep2Form:function(a){return this.errorRegistrationStep2Hide(a),this.$registration_step2_container.fadeOut(),!1},errorRegistration:function(a){"password"==a.type?(this.errorInputMark(this.$registration_password),this.$registration_password.focus()):(this.errorInputMark(this.$registration_email),this.$registration_email.focus()),console.log(a.description),this.$registration_error.html(a.description),this.$registration_error.fadeIn()},errorRegistrationHide:function(a){return a&&a.keyCode&&13==a.keyCode?!1:(this.$registration_error.hide(),!1)},postRegistrationForm:function(a){a.preventDefault(),a.stopPropagation();var b=this.$registration_email.val(),c=this.$registration_password.val(),d=this.$registration_first_name.val(),e=this.$registration_last_name.val();return _.isEmail(b)?c.length<6?this.trigger("error:registration:step2",{type:"password",description:qst.localize("Please use at least 6 characters","auth")}):c.length>16?this.trigger("error:registration:step2",{type:"password",description:qst.localize("You can&#39;t use more than 16 characters","auth")}):d?e?this.model.registration.fetch({login:b,password:c,first_name:d,last_name:e}):this.trigger("error:registration:step2",{type:"last_name",description:qst.localize("Enter your last name","auth")}):this.trigger("error:registration:step2",{type:"first_name",description:qst.localize("Enter your first name","auth")}):this.trigger("error:registration:step2",{type:"login",description:qst.localize("Doesn&#39;t look like a valid email!","auth")}),!1},errorRegistrationStep2:function(a){"first_name"==a.type?(this.errorInputMark(this.$registration_first_name),this.$registration_first_name.focus()):"last_name"==a.type&&(this.errorInputMark(this.$registration_last_name),this.$registration_last_name.focus()),this.$registration_step2_error.html(a.description),this.$registration_step2_error.fadeIn()},errorRegistrationStep2Hide:function(a){return a&&a.keyCode&&13==a.keyCode?!1:(this.$registration_step2_error.hide(),!1)},errorInputMark:function(a){a.toggleClass("input_error",!0)},errorInputUnmark:function(){this.$el.find(":input").toggleClass("input_error",!1)}}),qst.Auth=Backbone.Model.extend({url_logout:"/api/auth/logout/",initialize:function(){this.FB=new qst.FB,this.VK=new qst.VK({url:"/api/auth/",app_id:3154513,redirect_url:"http://weheartpics.com/go/close_vk.html"}),this.signin=new qst.Signin({url:"/api/auth/signin/"}),this.registration=new qst.Registration({url:"/api/auth/signup/"}),this.on("vkontakte:hi",function(a){this.VK.fetch(a)},this),this.FB.on("auth:success",this.authSuccess,this),this.VK.on("auth:success",this.authSuccess,this),this.signin.on("auth:success",this.authSuccess,this),this.registration.on("auth:success",this.authSuccess,this),this.FB.on("error",this.error,this),this.signin.on("error",this.error,this),this.registration.on("error",this.error,this),this.registration.on("registration:pending",function(a){qst.navigate("/confirmation/"+a.login,{trigger:!0})},this),this.registration.on("registration:success",function(){qst.navigate("/",{trigger:!0})},this),qst.on("auth:show",function(a){this.trigger("auth:show",a)},this),qst.on("navbar:logout",function(){this.logout()},this),this.view=new qst.AuthView({model:this}),this.view.render()},authSuccess:function(a){a.session&&this.trigger("auth:success",a)},logout:function(){this.trigger("auth:clear")},error:function(a){this.trigger("error",a)}}),qst.Config=function(){return{}},qst.Statistic=Backbone.Model.extend({url:"/api/photo/share/",initialize:function(){},trackCurrentPageChange:function(){return this.trackPageChange(window.location.pathname),!0},trackPageChange:function(a){var b=a.toString();"/"!=b.charAt(0)&&(b="/"+b),_gaq.push(["_trackPageview",b])},trackLike:function(){var a=_.getLS("qst_likec");_.isNaN(a)&&(a=0),a++,_.setLS("qst_likec",a,6e4)},trackComment:function(a){var b=_.getLS("qst_comc");_.isNaN(b)&&(b=0),b++,_.setLS("qst_comc",b,6e4);var c=1==a;c?_gaq.push(["_trackEvent","Photo","reply"]):_gaq.push(["_trackEvent","Photo","comment"])},trackShare:function(a){if("SHARE_FACEBOOK"==a){var b=_.getLS("qst_shrc");_.isNaN(b)&&(b=0),b++,_.setLS("qst_shrc",b,6e4)}_gaq.push(["_trackEvent","Photo","share",a])},trackTimeline:function(a,b){var c="USER_TIMELINE_";a&&(c="MAIN_TIMELINE_"),_gaq.push(["_trackEvent","Timeline","PagesLoaded",c+b,b])},trackNotifications:function(a){_gaq.push(["_trackEvent","Notifications","PagesLoaded","PAGES_LOADED_"+a,a])},trackDownload:function(a){_gaq.push(["_trackEvent","Download","click",a])},trackEmptyTimeline:function(a){var b="SHOW_TIMELINE_USER_EMPTY";a&&(b="SHOW_TIMELINE_MAIN_EMPTY"),_gaq.push(["_trackEvent","Download","Views",b])},trackPhotoPlateShow:function(){_gaq.push(["_trackEvent","Download","Views","SHOW_PHOTO_PAGE_PLATE"])},trackDownloadButtonMenu:function(a){var b="SHOW_DOWNLOAD_MENU_NEW";a||(b="SHOW_DOWNLOAD_MENU"),_gaq.push(["_trackEvent","Download","Views",b])},trackEmptyStories:function(){_gaq.push(["_trackEvent","Download","Views","SHOW_EMPTYSTORIES_DOWNLOAD"])},trackShowMainButton:function(){_gaq.push(["_trackEvent","Download","Views","SHOW_MAIN_DOWNLOAD"])},trackXclick:function(){_gaq.push(["_trackEvent","Download","Views","SHOW_CLICK_CLOSE_PLATE"])},trackShuffle:function(){var a=parseInt(_.getLS("qstsc"));_.isNaN(a)&&(a=0),a++,_.setLS("qstsc",a,1e3),_gaq.push(["_trackEvent","Other","Shuffle","click",a])}}),qst.App=Backbone.Model.extend({_didScroll:!1,initialize:function(){this.$og_image=$("#og_image"),this.$og_url=$("#og_url");var a=this,b=window.qst;this.config=new b.Config,this.statistic=new b.Statistic,this.router=new b.Router,this.pages=new b.PagesCollection,this.user=new b.User,b.user=this.user,this.auth=new b.Auth,b.config=this.config,this.navbar=new b.Navbar,this.header=new b.Header,this.upscroller=new b.UpScrollerView,this.pages.add(new b.Page({name:"404",template:"pages/404-page"})),this.pages.add(new b.Page({name:"403",template:"pages/403-page"})),this.itemlist=new b.ItemListPage({name:"itemlist",template:"pages/itemlist-page"}),this.pages.add(this.itemlist),this.landing=new b.LandingPage({name:"landing",template:"pages/landing-page"}),this.pages.add(this.landing),this.profile=new b.ProfilePage({name:"profile",template:"pages/profile-page"}),this.pages.add(this.profile),this.itemedit=new b.ItemEditPage({name:"itemedit",template:"pages/itemedit-page"}),this.pages.add(this.itemedit),this.router.on("404",function(){a.pages.getPage("404").render()}),this.router.on("route",function(a,c,d){switch(console.log("route:"+a),this.statistic.trackCurrentPageChange(),b.trigger("route",a,c,d),a){case"er404":this.pages.getPage("404").render();break;case"er403":this.pages.getPage("403").render();break;case"landing":b.is_authed()?b.navigate("/items",{trigger:!0}):this.landing.render();break;case"profile":c[0]||b.is_authed()?this.profile.render({mine:!c[0]||c[0]===b.user.get("uid"),user:c[0]?c[0]:b.user.get("uid"),section:c[1],category:c[2],story:c[3],sort:c[4]}):b.navigate("/",{trigger:!0});break;
case"itemlist":b.is_authed()?this.itemlist.render():b.navigate("/403",{trigger:!0});break;case"itemedit":b.is_authed()?this.itemedit.render({id:c[0],section:c[1]?c[1]:"main"}):b.navigate("/",{trigger:!0});break;default:c[0]&&!this.router.previousWasPopup()}this.trigger("need:meta:update")},this),this.router.on("reset",function(a,c){if(console.log(a,c),!this.router.isPopup(c))switch(this.router.isPopup(a)||b.speedScrollTop(0,1),a){case"landing":console.log("reset:landing"),this.landing.sleep();break;case"itemlist":console.log("reset:itemlist"),this.itemlist.sleep();break;case"profile":console.log("reset:profile"),this.profile.sleep();break;case"itemedit":console.log("reset:itemedit"),this.itemedit.sleep()}this.router.isPopup(a)&&_.forEach(this.pages.models,function(a){a.sleep&&a.get("name")!=c&&a.sleep()})},this),this.on("need:meta:update",function(){this.$og_url.attr("content",window.location.href)},this),b.on("historyback",function(){b.navigate(this.router.back_path,{trigger:!0})},this),b.on("historyback:reload",function(){b.trigger("historyback"),window.location.reload()},this),b.on("auth:clear",function(){b.navigate("/logout",{trigger:!0})}),this.on("twitter:hi",function(a){this.auth.trigger("twitter:hi",a)},this),this.on("vkontakte:hi",function(a){this.auth.trigger("vkontakte:hi",a)},this),this.on("error",function(a){console.error("error"),a&&a.description&&b.error(a.description)}),this.auth.on("auth:success",function(a){b.trigger("auth:success",a),("landing"===this.router.current_route||""===this.router.current_route)&&b.navigate("/items",{trigger:!0})},this),this.auth.on("auth:clear",function(){b.trigger("auth:clear")},this),this.user.on("user:error",function(a){this.trigger("error",a),b.trigger("auth:clear")},this),this.user.on("session:checked",function(){b.trigger("session:checked"),console.log("session:checked")},this),this.user.settings.on("change:geo_position",function(a,c){b.trigger("geo_position:ready",c)},this),this.user.settings.on("usersettings:ready",function(a){b.trigger("usersettings:ready",a)},this),this.navbar.on("auth:show",function(){b.trigger("auth:show")},this),this.navbar.on("navbar:logout",function(){b.trigger("navbar:logout")},this);var c=$(window),d=$(document);$(window).scroll(function(){var a=c.scrollTop(),e=d.height(),f=c.height();b.trigger("scroll",{s_top:a,d_h:e,w_h:f}),a+150>=e-f&&b.trigger("pagebottom:reached")}),b.is_authed()||this.navbar.show(),b.trigger("app:init")}}),qst.Router=Backbone.Router.extend({_previous_route:"",previous_route:"",previous_page_route:"",current_route:"",_back_path:"",back_path:"",route_passed:0,context:{},routes:{"":"landing","/":"landing",".":"landing",logout:"logout",items:"itemlist",profile:"profile","item/:id":"itemedit","item/:id/:slide":"itemedit",404:"er404",403:"er403","*default":"er404"},popoup_routes:["auth"],itemlist:function(){},itemedit:function(){},profile:function(){},logout:function(){localStorage.clear(),this.navigate("/"),window.location.reload()},er404:function(){return console.log("no such route ",arguments),this.trigger("404",arguments),!1},er403:function(){return console.log("access dinied route ",arguments),this.trigger("403",arguments),!1},initialize:function(){var a=_.uniq(_.values(this.routes));_(a).each(function(a){this.on("route:"+a,function(){this.route_passed++,this._previous_route&&this._previous_route!=a&&(this.trigger("reset",this._previous_route,a,this._back_path),this.trigger("reset:"+this._previous_route)),this._previous_route=a,this._back_path=Backbone.history.fragment},this)},this),this.on("reset",function(a,b,c){this.back_path=c,this.current_route=b,this.previous_route=a,this.isPopup(this.previous_route)||(this.previous_page_route=this.previous_route)})},previousWasPopup:function(){return this.isPopup(this.previous_route)},currentIsPopup:function(){return this.isPopup(this.current_route)},isPopup:function(a){return-1!==_.indexOf(this.popoup_routes,a)}}),qst.Navbar=Backbone.Model.extend({defaults:{user:null,currentItem:"photofeed"},initialize:function(){this.view=new qst.NavbarView({model:this}),qst.on("route",function(a){this.set("currentItem",a)},this)},show:function(){this.view.show()}}),qst.NavbarView=Backbone.View.extend({template:"blocks/navbar",el:".navbar-header",_navItemPrefix:"navbar__item-",_navMiscPrefix:"nav__",events:{"click .nav__login>a":"login","click .nav__logout>a":"logout","click .nav__profile-drop>a":"toggleDrop","click li>a":"mobileToggleDrop"},initialize:function(){this.template=qst.Templates.get(this.template),this.render(),this.model.on("change:currentItem",this.changeItem,this),qst.on("usersettings:ready",this.toggleAuth,this),$("html").on("click.navbar",_.bind(this.hideDrop,this))},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.$balance=this.$el.find(".nav__balance-title")},show:function(){this.$el.toggleClass("navbar_hidden",!1)},toggleAuth:function(a){this.show(),this.$balance&&0!=a.balance&&this.$balance.html(a.balance+"&nbsp;"+qst.localize(a.currency,"currency")),this.$el.toggleClass("logged",!0)},toggleDrop:function(){return this.$el.toggleClass("open"),!1},mobileToggleDrop:function(){var a=$(window).width()<650;a&&this.toggleDrop()},hideDrop:function(){var a=$(window).width()<650;a||this.$el.toggleClass("open",!1)},changeItem:function(a){var b=a.get("currentItem");this.$el.find(".nav li").toggleClass("active",!1),this.$el.find(".nav li."+this._navItemPrefix+b).toggleClass("active",!0),this.$el.find(".nav li."+this._navMiscPrefix+b).toggleClass("active",!0)},login:function(){return this.model.trigger("auth:show"),!1},logout:function(){return this.model.trigger("navbar:logout"),!1}}),qst.Header=Backbone.Model.extend({defaults:{items:{},currentItem:"defaults"},initialize:function(){this.set("items",Handlebars.helpers._("items","header").string),this.view=new qst.HeaderView({model:this}),qst.on("route",this.changeItem,this)},changeItem:function(a){return qst.app.router.currentIsPopup()?!1:(this.get("items")[a]?this.set("currentItem",a):this.set("currentItem","defaults"),void 0)}}),qst.HeaderView=Backbone.View.extend({template:"blocks/header",el:".page-header",initialize:function(){this.template=qst.Templates.get(this.template),this.render(),this.model.on("change:currentItem",this.render,this)},render:function(){var a=this.template(this.model.get("items")[this.model.get("currentItem")]);"defaults"===this.model.get("currentItem")?this.$el.toggleClass("hidden",!0):this.$el.toggleClass("hidden",!1),this.$el.html(a)}}),qst.ItemListPage=qst.Page.extend({visited:!1,defaults:{sleeped:!0,total:0},initialize:function(a){a=a||{},qst.on("link:delete",this.decTotal,this)},needRerender:function(){return this.get("sleeped")},render:function(a){return qst.is_needauth()?!1:this.needRerender()?(a=a||{},this.visited?(a.user=qst.user.get("uid"),this.itemlist.set(a),this.view.render(),this.itemlist.activate(),this.view.addItemList(this.itemlist),this.view.addAddDialog(this.adddialog),this.adddialog.activate(),this.itemlist.reset(),this.set("sleeped",!1)):(this.visited=!0,this.view=new qst.ItemListPageView({model:this,template:"pages/itemlist-page"}),this.view.render(),a.user=qst.user.get("uid"),this.itemlist=new qst.ItemList(a),this.adddialog=new qst.AddDialog(a),this.adddialog.on("add:success",this.linkAdded,this),this.adddialog.on("add:error",this.error,this),this.itemlist.activate(),this.itemlist.on("load:success",this.loadList,this),this.view.addItemList(this.itemlist),this.view.addAddDialog(this.adddialog),this.adddialog.activate(),this.set("sleeped",!1)),void 0):!1},loadList:function(a){this.set("total",a.total),this.view.updateTotal(a.total)},decTotal:function(){if(this.get("total")>0){var a=this.get("total")-1;this.set("total",a),this.view.updateTotal(a)}},linkAdded:function(a){_.isEmpty(a)||this.itemlist.addMyBlock(a)},error:function(){qst.warning(qst.localize("Something went wrong...","misc"))},sleep:function(){return this.get("sleeped")?!1:(this.set("sleeped",!0),this.itemlist&&this.itemlist.sleep(),this.adddialog&&this.adddialog.sleep(),void 0)}}),qst.ItemListPageView=qst.PageView.extend({$header:null,addAddDialog:function(a){this.$header||(this.$header=$(".page-header")),this.$header.find(".helper").html(a.view.$el)},addItemList:function(a){this.$el.find(".itemlist-row").html(a.view.$el)},updateTotal:function(a){this.$header||(this.$header=$(".page-header")),this.$header.find("h1").html(a+" "+Handlebars.helpers._plural(a,"item"))}}),qst.ItemList=Backbone.Model.extend({collection:null,defaults:{user:0,offset:0,limit:15,loading:!1,sleeped:!1,scrollload:!0},initialize:function(){this.collection=new qst.LinkCollection,this.collection.on("load:success",function(a){this.trigger("load:success",a),this.set("offset",this.get("offset")+this.get("limit")),this.set("loading",!1)},this),this.collection.on("load:error",function(){console.error("photofeed:load:error"),this.set("loading",!1)},this),this.collection.on("load:start",function(){this.set("loading",!0)},this),this.collection.on("add",this.addBlock,this),this.collection.on("reset",this.resetBlocks,this),this.view=new qst.ItemListView({collection:this.collection,model:this}),this.on("needmore",this.needMore,this),qst.on("link:delete",this.deleteBlock,this),this.get("scrollload")&&qst.on("pagebottom:reached",function(){this.trigger("needmore")},this)},addMyBlock:function(a){var b=new qst.Link(a);this.addBlock(b),this.collection.add(b,{at:-1})},addBlock:function(a){a.toJSON(),a.fetch()},resetBlocks:function(a,b){_.each(b.previousModels,function(a){a.remove()}),this.collection.more=!0},needMore:function(){if(!this.get("loading")&&!this.get("sleeped")){var a=this.toJSON();delete a.loading,delete a.sleeped,delete a.scrollload,this.collection.fetch({data:a})}},deleteBlock:function(a){var b=a.id;this.get("offset")>0&&this.set("offset",this.get("offset")-1);var c=_.find(this.collection.models,function(a){return a.get("id")==b});c.delayedRemove()},reset:function(){return this.set("offset",this.defaults.offset),this.collection.reset(),this.trigger("needmore"),!1},activate:function(){this.set("offset",this.defaults.offset),this.set("sleeped",!1),this.trigger("needmore")},sleep:function(){this.set("sleeped",!0)}}),qst.ItemListView=Backbone.View.extend({tagName:"div",className:"itemlist",template:"blocks/itemlist",initialize:function(a){this.collection=a.collection,this.collection.on("add",this.addBlock,this),this.collection.on("load:start",this.showSpinner,this),this.collection.on("load:success",this.hideSpinner,this),this.collection.on("load:error",this.hideSpinner,this),this.$spinner=null,this.model=a.model,this.render()},render:function(){this.template=qst.Templates.get(this.template);var a=this.template(this.model.toJSON());this.$el.html(a),this.$cont=this.$el.find(".itemlist__table"),this.showSpinner()},addBlock:function(a,b,c){c&&-1===c.at?this.$cont.prepend(a.view.$el):this.$cont.append(a.view.$el)},showSpinner:function(){this.$spinner?this.$spinner.toggleClass("hidden",!1):this.$spinner=this.$el.find(".itemlist__spinner")},hideSpinner:function(){this.$spinner&&!this.collection.more&&this.$spinner.toggleClass("hidden",!0)}}),qst.Link=Backbone.Model.extend({url:"/v1/links/",defaults:{},initialize:function(){this.view=new qst.LinkView({model:this})},fetch:function(){parseInt(this.get("counter_ship"))?this.set("ctr",this.get("counter_view")/this.get("counter_ship")):this.set("ctr",0),this.set("overall",this.get("price")*this.get("counter_ship")),this.view.render(),this.on("change:active",this.toggleActive,this)},toggleActive:function(){return options={},options.url=this.url+this.get("id"),options.type="post",options.data=options.data||{active:this.get("active")?1:0},Backbone.Model.prototype.fetch.call(this,options)},deleteItem:function(a){var b={};console.lo,b.data={},a&&(a.url&&(b.url=a.url),a.method&&(b.method=a.method),a.content&&(b.content=a.content),a.ok&&(b.ok_title=a.ok),a.close&&(b.close_title=a.close),a.success&&(b.success_title=a.success),a.error&&(b.error_title=a.error),a.event&&(b.event=a.event),a.eventdata&&(b.eventdata=a.eventdata)),new qst.Confirm(b)},remove:function(){this.stopListening(),this.clear({silent:!0}),this.view.remove()},delayedRemove:function(){this.view.delayedRemove();var a=this;setTimeout(function(){a.remove()},300)}}),qst.LinkView=Backbone.View.extend({template:"blocks/link",tagName:"table",className:"itemlist__link",events:{"click .link__toggle-a":"toggle","click .link__delete-a":"delete"},$vote:null,$caption:null,$location_name:null,$location_addr:null,$likers:null,$comments:null,initialize:function(){this.template=qst.Templates.get(this.template)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a)},toggle:function(a){return this.model.get("active")?(this.model.set("active",!1),$(a.currentTarget).parents(".link__toggle").toggleClass("on",!1).toggleClass("off",!0)):(this.model.set("active",!0),$(a.currentTarget).parents(".link__toggle").toggleClass("on",!0).toggleClass("off",!1)),!1},"delete":function(a){return this.model.deleteItem($(a.currentTarget).data()),!1},delayedRemove:function(){var a=this;this.$el.css({height:this.$el.outerHeight()}),setTimeout(function(){a.$el.toggleClass("removing",!0),a.$el.css({opacity:0,height:0})},50)}}),qst.LinkCollection=Backbone.Collection.extend({url:"/v1/links/",model:qst.Link,more:!0,parse:function(a){return a=_.toJSON(a),a.result&&a.result.items?(this.total=parseInt(a.result.totalmore),this.more=a.result.more,a.result.items?a.result.items:!1):void 0},fetch:function(a){return this.more?(a=a||{},a.type="get",a.update=!0,a.remove=!1,a.data=a.data||{offset:0,limit:30},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Collection.prototype.fetch.call(this,a)):void 0},success:function(a,b){b=_.toJSON(b),b.error?this.trigger("load:error"):this.trigger("load:success",{total:this.total})},error:function(){this.trigger("load:error")}}),qst.AddDialog=Backbone.Model.extend({url:"/v1/links/",defaults:{name:"название ссылки",url:"медиа для продажи",price:1e3,description:"",price_pwyw:0,active:1,user:"",state:"",sleeped:!1},initialize:function(){this.view=new qst.AddDialogView({model:this}),this.set("state","link")},fetch:function(a){var b=this.toJSON();return b.price_pwyw&&(b.price+="+"),""===$.trim(b.description)&&delete b.description,delete b.active,delete b.price_pwyw,delete b.sleeped,delete b.state,delete b.user,a=a||{},a.type="post",a.data=a.data||b,a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),b.success?this.trigger("add:success",b.result):this.trigger("add:error")},error:function(){this.trigger("add:error")},upload:function(a){if(a){this.view.updateFileName(a.name);var b=this,c=new FormData;c.append("input_file",a);var d=new XMLHttpRequest;d.upload.addEventListener("progress",function(a){b.view.updateFileProcess(a.loaded/a.total)},!1),d.onreadystatechange=function(){if(4==d.readyState)if(200==d.status){var c=this.response;"string"==typeof c&&(c=$.parseJSON(c)),c.success?(b.view.updateFileProcess(1),b.set("url",c.result.uri)):b.trigger("add:error")}else console.log(a.name+":"+"ERROR: "+d.readyState+":"+d.status)},d.open("POST","/v1/medias/?token="+qst.user.get("token"),!0),d.send(c)}},reset:function(){return!1},activate:function(){this.set("sleeped",!1)},sleep:function(){this.set("sleeped",!0)}}),qst.AddDialogView=Backbone.View.extend({template:"blocks/adddialog",tagName:"div",className:"adddialog",events:{"click a.adddialog__add":"showDialog","click a.item__types-item":"clickState","click .adddialog__header":"hideDialog","click .adddialog__submit-a":"submitForm","change #file_uploader":"upload",keyoress:"hideErrors",click:"hideErrors","submit form":"submit"},initialize:function(){this.render(),this.model.on("add:success",this.hideDialog,this),this.model.on("change:sleeped",this.sleep,this),this.model.on("change:state",this.changeState,this),this.model.on("change:url",this.changeLink,this)},render:function(){this.template=qst.Templates.get(this.template);var a=this.template(this.model.toJSON());this.$el.append(a),this.$state_items=this.$el.find(".item__types-item"),this.$form=this.$el.find("form"),this.$input_name=this.$form.find("input[name=name]"),this.$input_price=this.$form.find("input[name=price]"),this.$input_link=this.$form.find("input[name=link]"),this.$input_file=this.$form.find("input[name=file]"),this.$input_file_title=this.$form.find(".itemedit__inp-file-title"),this.$input_file_process=this.$form.find(".itemedit__inp-file-process"),this.$error=this.$el.find(".adddialog__error"),this.delegateEvents(),$("html").on("click.adddialog",_.bind(this.clickOutside,this))},clickState:function(a){var b=$(a.target);return this.model.set("state",b.attr("href")),!1},changeState:function(a,b){this.$state_items.parent().toggleClass("active",!1),this.$state_items.filter(".item-"+b).parent().toggleClass("active",!0),this.$el.toggleClass("state-link",!1).toggleClass("state-file",!1).toggleClass("state-nothing",!1).toggleClass("state-"+b,!0),"file"===b?this.$input_link.attr("disabled","disabled"):this.$input_link.removeAttr("disabled")},showDialog:function(a){return a.stopPropagation(),this.$el.toggleClass("open",!0),this.$input_name.focus(),!1},clearDialog:function(){this.$input_name.val(""),this.$input_price.val(""),this.$input_link.val(""),this.$input_file.val(""),this.updateFileName(qst.localize("Drop or choose a file","itemlist")),this.updateFileProcess(0)},hideDialog:function(){this.clearDialog(),this.$el.toggleClass("open",!1)},clickOutside:function(a){$(a.target).parents(".adddialog").length||this.hideDialog()},submit:function(){var a=this.$input_name.val(),b=this.$input_price.val(),c=this.$input_link.val(),d=this.$input_file.val(),e=this.model.get("state");if(_.isEmpty(a))return this.showError(qst.localize("write some name of the item","itemlist"),"name"),!1;if(_.isEmpty(b)||_.isNaN(parseInt(b)))return this.showError(qst.localize("set price, please","itemlist"),"price"),!1;if("link"===e){if(_.isEmpty(c))return this.showError(qst.localize("set a link, please","itemlist"),"link"),!1;if(!_.isUrl(c))return this.showError(qst.localize("set a valid link, please","itemlist"),"link"),!1}else if("file"===e&&_.isEmpty(d))return this.showError(qst.localize("load some file, please","itemlist"),"file"),!1;var f=-1!==b.indexOf("+");return this.model.set({name:a,url:c,price:parseInt(b),price_pwyw:f+0}),this.model.fetch(),!1},showError:function(a,b){switch(this.$error.text(a),this.$el.toggleClass("error",!0),b){case"name":this.$input_name.parent().toggleClass("error-inp",!0),this.$input_name.focus();break;case"price":this.$input_price.parent().toggleClass("error-inp",!0),this.$input_price.focus();break;case"link":this.$input_link.parent().toggleClass("error-inp",!0),this.$input_link.focus();break;case"file":this.$input_file.parent().toggleClass("error-inp",!0)}},hideErrors:function(){this.$el.toggleClass("error",!1),this.$el.find(".error-inp").toggleClass("error-inp",!1)},submitForm:function(){return this.$form.submit(),!1},sleep:function(a,b,c){this.hideDialog(),console.log(a,b,c),b?(this.undelegateEvents(),$("html").off("click.adddialog")):(this.delegateEvents(),$("html").on("click.adddialog",_.bind(this.clickOutside,this)))},reset:function(){},remove:function(){this.undelegateEvents(),$("html").off("click.adddialog")},upload:function(a){var b=this;$.each(a.target.files,function(a,c){b.model.upload(c)})},updateFileName:function(a){this.$input_file_title.text(a)},updateFileProcess:function(a){this.$input_file_process.width(Math.round(100*a)+"%")},changeLink:function(a,b){this.$input_link.val(b)}}),qst.LandingPage=qst.Page.extend({visited:!1,defaults:{img_num:0,lang:"en"},initialize:function(a){this.set("lang",qst.language),a=a||{}},render:function(){this.visited?this.view.render():(this.visited=!0,this.view=new qst.LandingPageView({model:this,template:"pages/landing-page"}),this.view.render())},sleep:function(){this.view&&this.view.sleep()}}),qst.LandingPageView=qst.PageView.extend({indent:66,$window:$(window),events:{},render:function(){if(this.renderedHtml)this.$el.append(this.renderedHtml);else{var a=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.template(this.model.toJSON()));this.trigger("page:preRender",a),this.$el.html(a)}if($("body").attr("class","body__page-"+this.model.get("name")),this.model.enterDocument(),this.trigger("page:render",this.model),this.trigger("enterDocument",this.model),this.$window.on("resize.landing.page",_.bind(this.repositionPage,this)),this.$sec1=this.$el.find(".landing-section1"),this.$secs=this.$el.find(".landing-section"),this.$sec5=this.$el.find(".landing-section5"),this.$fake_input=this.$el.find(".fake-input"),this.$real_input=this.$el.find(".landing-signup__inp"),this.repositionPage(),_.isPhone()&&$("html, body").animate({scrollTop:0},100),_.isPhone()){var b=new Image;b.onload=_.bind(this.section1ImgLoadFinish,this),b.src="/images/st/land-bg0_md.jpg"}else{var c=this;c.section1ImgLoadFinish()}this.delegateEvents()},section1ImgLoadFinish:function(){this.$sec1.toggleClass("landing-section1_md",!0)},repositionPage:function(){var a=0,b=$(window).width();if(640>=b){this.indent=44;var c=$("html").hasClass("with-top-banner");c&&(this.indent=this.indent+100),a=Math.max(this.$window.innerHeight(),436);var d=Math.min(Math.max(a,480),640);this.$secs.height(d),this.$sec1.height(a-this.indent),this.$sec5.height(Math.round(1.5*d))}else if(b>640&&950>=b){this.indent=66;var c=$("html").hasClass("with-top-banner");c&&(this.indent=this.indent+100),a=this.$window.innerHeight()-this.indent;var d=Math.max(a,850);this.$secs.height(d),this.$sec1.height(a)}else{this.indent=66;var c=$("html").hasClass("with-top-banner");c&&(this.indent=this.indent+100),a=this.$window.innerHeight()-this.indent;var d=Math.max(a,800);this.$secs.height(d),this.$sec1.height(a)}var e=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],f=this;$.each(e,function(a,b){f.$fake_input.get(0).style[b]=f.$real_input.css(b)}),this.$real_input.width(this.$fake_input.width())},sleep:function(){this.$window.off("resize.landing.page"),this.undelegateEvents()}}),qst.ProfilePage=qst.Page.extend({visited:!1,visited_info:!1,visited_feed:!1,visited_explore:!1,defaults:{mine:!1,user:0,section:"info",category:"whole",story:"whole",sort:"date",sleeped:!0},initialize:function(a){a=a||{}},needRerender:function(a){return this.get("sleeped")||a.user!=this.get("user")||a.section!=this.get("section")||a.category!=this.get("category")||a.story!=this.get("story")||a.sort!=this.get("sort")},render:function(a){if(a.user||(a.user=qst.user.get("uid")||this.defaults.user),a.section||(a.section=this.defaults.section),a.category||(a.category=this.defaults.category),a.story||(a.story=this.defaults.story),a.sort||(a.sort=this.defaults.sort),!this.needRerender(a))return!1;this.set(a);var b=_.extend(a,{keeper_path:"qst.app.profile.grid.collection",addphoto:!0,filter:"user"});_.isPhone()?(this.visited?this.view.render():(this.visited=!0,this.view=new qst.ProfilePageView({model:this,template:"pages/profile-page"}),this.view.render()),this.set("sleeped",!1),this.visited_info?(this.user_info.set(a),this.user_info.activate(),this.view.addUserInfo(this.user_info)):(this.visited_info=!0,this.user_info=new qst.UserInfo(a),this.user_info.activate(),this.view.addUserInfo(this.user_info)),"info"===this.get("section")?(this.grid&&this.grid.sleep(),this.photofeed&&this.photofeed.sleep()):"feed"===this.get("section")?(this.grid&&this.grid.sleep(),this.user_info&&this.user_info.sleep(),this.visited_feed?(this.photofeed.set(a),this.photofeed.activate(),this.view.addPhotofeed(this.photofeed),this.photofeed.reset()):(this.visited_feed=!0,this.photofeed=new qst.Photofeed(a),this.photofeed.activate(),this.view.addPhotofeed(this.photofeed))):"explore"===this.get("section")&&(this.photofeed&&this.photofeed.sleep(),this.user_info&&this.user_info.sleep(),this.visited_explore?(this.grid.set(b),this.grid.activate(),this.view.addGrid(this.grid),this.grid.reset(),this.story_menu.set(_.extend(a,{root_path:"/user/"+a.user+"/explore"})),this.view.addStoryMenu(this.story_menu),this.story_menu.activate()):(this.visited_explore=!0,this.grid=new qst.PicTileGrid(b),this.grid.activate(),this.view.addGrid(this.grid),this.story_menu=new qst.StoryMenu(_.extend(a,{root_path:"/user/"+a.user+"/explore"})),this.story_menu.fetch(),this.view.addStoryMenu(this.story_menu),this.story_menu.activate()))):(this.visited?(this.view.render(),this.user_info.set(a),this.story_menu.set(_.extend(a,{root_path:"/user/"+a.user+"/explore"})),this.user_info.activate(),this.view.addUserInfo(this.user_info),this.view.addStoryMenu(this.story_menu),this.story_menu.activate(),this.set("sleeped",!1)):(this.visited=!0,this.view=new qst.ProfilePageView({model:this,template:"pages/profile-page"}),this.view.render(),this.user_info=new qst.UserInfo(a),this.user_info.activate(),this.story_menu=new qst.StoryMenu(_.extend(a,{root_path:"/user/"+a.user+"/explore"})),this.story_menu.fetch(),this.view.addUserInfo(this.user_info),this.view.addStoryMenu(this.story_menu),this.story_menu.activate(),this.set("sleeped",!1)),"feed"===this.get("section")?(this.grid&&this.grid.sleep(),this.visited_feed?(this.photofeed.set(a),this.photofeed.activate(),this.view.addPhotofeed(this.photofeed),this.photofeed.reset()):(this.visited_feed=!0,this.photofeed=new qst.Photofeed(a),this.photofeed.activate(),this.view.addPhotofeed(this.photofeed))):("info"===this.get("section")||"explore"===this.get("section"))&&(this.photofeed&&this.photofeed.sleep(),this.visited_explore?(this.grid.set(b),this.grid.activate(),this.view.addGrid(this.grid),this.grid.reset()):(this.visited_explore=!0,this.grid=new qst.PicTileGrid(b),this.grid.activate(),this.view.addGrid(this.grid))))},sleep:function(){return this.get("sleeped")?!1:(this.set("sleeped",!0),this.photofeed&&this.photofeed.sleep(),this.grid&&this.grid.sleep(),this.user_info&&this.user_info.sleep(),this.story_menu&&this.story_menu.sleep(),void 0)}}),qst.ProfilePageView=qst.PageView.extend({initialize:function(a){return a&&a.template?(this.template=qst.Templates.get(a.template),this.createDom(),void 0):(qst.error("Page must have a template"),void 0)},render:function(){if(this.renderedHtml)this.$el.append(this.renderedHtml);else{var a=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.template(this.model.toJSON()));this.trigger("page:preRender",a),this.$el.html(a)}this.model.get("mine")?$("body").attr("class","body__page-my-"+this.model.get("name")+" body__page-"+this.model.get("name")):$("body").attr("class","body__page-"+this.model.get("name")),this.model.enterDocument(),this.trigger("page:render",this.model),this.trigger("enterDocument",this.model)},addPhotofeed:function(a){this.$el.find(".profile-feed-col").html(a.view.$el)},addGrid:function(a){this.$el.find(".profile-feed-col").html(a.view.$el)},addUserInfo:function(a){this.$el.find(".user-info-col").html(a.view.$el)},addStoryMenu:function(a){this.$el.find(".story-menu-row").html(a.view.$el)}}),qst.UserInfo=Backbone.Model.extend({url:"/api/user/",defaults:{sleeped:!0,user_id:0,loading_follow:!1,user:0,fields:"id,name,first_name,last_name,followers_count,followings_count,photos_count,tw_name,photo,is_awesome,awesome_account,bio,fb_id,fb_name,vk_id,vk_name,tw_id,tw_name,background,follow",user_obj:{}},initialize:function(){var a="blocks/user-info";_.isPhone()&&(a="blocks/user-info_phone"),this.view=new qst.UserInfoView({template:a,model:this})},fetch:function(a){return a=a||{},a.type="post",a.data=a.data||{user:this.get("user"),fields:this.get("fields")},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},follow:function(){var a="";this.set("loading_follow",!0),this.get("user_obj").follow?(a="/api/friends/unfollow/",this.get("user_obj").follow=!1):(a="/api/friends/follow/",this.get("user_obj").follow=!0),$.ajax({url:qst.authUrl(a),type:"POST",data:{user:this.get("user_id")},success:_.bind(this.followSuccess,this)})},followSuccess:function(){this.set("loading_follow",!1)},saveBio:function(){$.ajax({url:qst.authUrl("/api/user/update/"),type:"POST",data:{bio:this.get("user_obj").bio}})},success:function(a,b){b=_.toJSON(b),this.set("user_obj",b.user),b.error?this.trigger("userinfo:error"):this.trigger("load:success")},error:function(){this.trigger("userinfo:error")},editBio:function(a){return this.get("user_obj").bio==a?!1:(this.get("user_obj").bio=a,this.saveBio(),!0)},reportUser:function(a){var b={};b.data={user:this.get("user_id")},a&&(a.url&&(b.url=a.url),a.content&&(b.content=a.content),a.ok&&(b.ok_title=a.ok),a.close&&(b.close_title=a.close),a.success&&(b.success_title=a.success),a.error&&(b.error_title=a.error)),new qst.Confirm(b)},activate:function(){this.set("loading_follow",!1),this.set("sleeped",!1),this.get("user_id")!=this.get("user")?(this.view.clear(),this.set("user_id",this.get("user")),this.fetch()):(this.view.clearAutoSize(),this.view.activate())},sleep:function(){this.set("loading_follow",!1),this.set("sleeped",!0),this.view.clearAutoSize()},reset:function(){return!1},remove:function(){this.view.reset(),this.view.remove(),this.stopListening(),this.clear({silent:!0})}}),qst.UserInfoView=Backbone.View.extend({template:"blocks/user-info",tagName:"div",className:"user-info",events:{"click .profile__interact-bio":"focusBio","click .profile__interact-message":"gotoMessage","click .profile__report-title":"reportUser","keypress .profile__bio-input":"inputBio","blur .profile__bio-input":"editBio","click .profile__follow-head":"follow"},initialize:function(a){a.template&&(this.template=a.template),this.template=qst.Templates.get(this.template),this.model.on("load:success",this.render,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.lazy_loader=new qst.LazyLoader,this.lazy_loader.load(this.$el),this.activate()},reportUser:function(){this.model.reportUser(this.$el.find(".profile__report-title").data())},gotoMessage:function(){qst.navigate("/dialogs/"+this.model.get("user_id")+"/",{trigger:!0})},follow:function(a){if(!this.model.get("loading_follow")){var b=$(a.currentTarget);b.toggleClass("followed"),this.model.follow()}},focusBio:function(){if(this.$input)if(this.model.get("user_obj").bio)this.$input.focus();else{var a=this;this.$el.find(".profile__bio").slideDown(200,function(){a.$input.focus()})}},editBio:function(){var a=$.trim(this.$input.val());this.model.editBio(a)},inputBio:function(a){return 13!==a.keyCode||a.altKey?void 0:(this.$input.blur(),this.editBio(),!1)},activate:function(){var a=this;this.delegateEvents(),this.model.get("mine")&&(this.$input=this.$el.find(".profile__bio-input"),this.$input.length&&(this.$input.autosize(),setTimeout(function(){a.$input.trigger("resize")},10)));var b=this.model.get("user_obj").name;b&&(this.$header=$("header h1"),this.$header.html(b));var c=this.model.get("user_obj").photos_count;c&&c>0&&(this.$explore_counter=$(".profile-explore__count"),this.$explore_counter.html(c))},clear:function(){this.$el.html(""),this.$header=$("header h1"),this.$header.html("")},clearAutoSize:function(){$(window).off("resize.texarea_autosize"),$(".autosizejs").remove()},reset:function(){delete this.lazy_loader,this.undelegateEvents(),this.$el.html("")}}),qst.ItemEditPage=qst.Page.extend({visited:!1,defaults:{id:0,section:"main",sleeped:!0},url:"",initialize:function(a){a=a||{}},needRerender:function(a){return this.get("sleeped")||a.id!=this.get("id")},render:function(a){return a.section||(a.section=this.defaults.section),this.set(a),this.needRerender(a)?(this.visited?(this.view.render(),this.menu.set(a),this.itemedit.set(a),this.itemedit.fetch(),this.itemedit.activate(),this.view.addMenu(this.menu),this.view.addItemEdit(this.itemedit),this.set("sleeped",!1)):(this.visited=!0,this.view=new qst.ItemEditPageView({model:this,template:"pages/itemedit-page"}),this.view.render(),this.menu=new qst.ItemEditMenu(a),this.itemedit=new qst.ItemEdit(a),this.itemedit.fetch(),this.itemedit.activate(),this.view.addMenu(this.menu),this.view.addItemEdit(this.itemedit),this.set("sleeped",!1)),void 0):!1
},sleep:function(){return this.get("sleeped")?!1:(this.set("sleeped",!0),this.menu&&this.menu.sleep(),this.itemedit&&this.itemedit.sleep(),void 0)}}),qst.ItemEditPageView=qst.PageView.extend({initialize:function(a){return a&&a.template?(this.template=qst.Templates.get(a.template),this.createDom(),this.model.on("change:section",this.changeSection,this),void 0):(qst.error("Page must have a template"),void 0)},render:function(){if(this.renderedHtml)this.$el.append(this.renderedHtml);else{var a=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.template(this.model.toJSON()));this.trigger("page:preRender",a),this.$el.html(a)}this.$cont=this.$el.find(">div>div"),$("body").attr("class","body__page-"+this.model.get("name")),this.model.enterDocument(),this.trigger("page:render",this.model),this.trigger("enterDocument",this.model)},changeSection:function(a,b){this.$cont&&this.$cont.removeAttr("class").addClass("page-itemedit_"+b)},addMenu:function(a){this.$el.find(".itemedit__menu-row").html(a.view.$el)},addItemEdit:function(a){this.$el.find(".itemedit__section-row").html(a.view.$el)}}),qst.ItemEditMenu=Backbone.Model.extend({url:"",defaults:{id:0,section:"main"},initialize:function(){this.view=new qst.ItemEditMenuView({model:this})},sleep:function(){}}),qst.ItemEditMenuView=Backbone.View.extend({template:"blocks/itemedit-menu",className:"itemedit-menu",initialize:function(){this.template=qst.Templates.get(this.template),this.render(),this.model.on("change:id",this.render,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a)}}),qst.ItemEdit=Backbone.Model.extend({url:"/v1/links/",defaults:{state:""},initialize:function(){this.view=new qst.ItemEditView({model:this})},fetch:function(a){return a=a||{},a.url=this.url+this.get("id"),a.type="get",a.data=a.data||{},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),this.set(b.result);var c=this.get("url");_.isEmpty(c)?this.set("state","nothing"):qst.isFile(c)?this.set("state","file"):this.set("state","link"),b.success?this.trigger("load:success"):this.trigger("load:error")},error:function(){this.trigger("load:error")},activate:function(){this.set("sleeped",!1)},sleep:function(){this.set("sleeped",!0)}}),qst.ItemEditView=Backbone.View.extend({template:"blocks/itemedit",className:"itemedit",events:{"click a.item__types-item":"clickState","change #file_uploader":"upload",click:"hideErrors","submit form":"submit"},initialize:function(){this.template=qst.Templates.get(this.template),this.model.on("load:success",this.render,this),this.model.on("change:sleeped",this.sleep,this),this.model.on("change:state",this.changeState,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.$state_items=this.$el.find(".item__types-item"),this.$form=this.$el.find("form"),this.$input_name=this.$form.find("input[name=name]"),this.$input_price=this.$form.find("input[name=price]"),this.$input_link=this.$form.find("input[name=link]"),this.$input_file=this.$form.find("input[name=file]"),this.$input_file_title=this.$form.find(".itemedit__inp-file-title"),this.$input_file_process=this.$form.find(".itemedit__inp-file-process"),this.$error=this.$el.find(".itemedit__error"),this.changeState(this.model,this.model.get("state")),this.delegateEvents()},clickState:function(a){var b=$(a.target);return this.model.set("state",b.attr("href")),!1},changeState:function(a,b){this.$state_items&&(this.$state_items.parent().toggleClass("active",!1),this.$state_items.filter(".item-"+b).parent().toggleClass("active",!0),this.$el.toggleClass("state-link",!1).toggleClass("state-file",!1).toggleClass("state-nothing",!1).toggleClass("state-"+b,!0),"file"===b?this.$input_link.attr("disabled","disabled"):this.$input_link.removeAttr("disabled"))},submit:function(){var a=this.$input_name.val(),b=this.$input_price.val(),c=this.$input_link.val(),d=this.$input_file.val(),e=this.model.get("state");if(_.isEmpty(a))return this.showError(qst.localize("write some name of the item","itemlist"),"name"),!1;if(_.isEmpty(b)||_.isNaN(parseInt(b)))return this.showError(qst.localize("set price, please","itemlist"),"price"),!1;if("link"===e){if(_.isEmpty(c))return this.showError(qst.localize("set a link, please","itemlist"),"link"),!1;if(!_.isUrl(c))return this.showError(qst.localize("set a valid link, please","itemlist"),"link"),!1}else if("file"===e&&_.isEmpty(d))return this.showError(qst.localize("load some file, please","itemlist"),"file"),!1;var f=-1!==b.indexOf("+");return this.model.set({name:a,url:c,price:parseInt(b),price_pwyw:f+0}),this.model.fetch(),!1},showError:function(a,b){switch(this.$error.text(a),this.$el.toggleClass("error",!0),b){case"name":this.$input_name.parent().toggleClass("error-inp",!0),this.$input_name.focus();break;case"price":this.$input_price.parent().toggleClass("error-inp",!0),this.$input_price.focus();break;case"link":this.$input_link.parent().toggleClass("error-inp",!0),this.$input_link.focus();break;case"file":this.$input_file.parent().toggleClass("error-inp",!0)}},hideErrors:function(){this.$el.toggleClass("error",!1),this.$el.find(".error-inp").toggleClass("error-inp",!1)},submitForm:function(){return this.$form.submit(),!1},sleep:function(a,b){b?this.undelegateEvents():this.delegateEvents()},upload:function(a){var b=this;$.each(a.target.files,function(a,c){b.model.upload(c)})},updateFileName:function(a){this.$input_file_title.text(a)},updateFileProcess:function(a){this.$input_file_process.width(Math.round(100*a)+"%")},changeLink:function(a,b){this.$input_link.val(b)}}),qst.UpScrollerView=Backbone.View.extend({tagName:"div",className:"up-scroller",inited:!1,inrvl:0,hidden:!0,events:{click:"click",mouseover:"mouseover",mouseout:"hide"},initialize:function(){this.inited||(this.inited=!0,this.render(),qst.on("scroll",this.smartShow,this))},render:function(){$("body").append(this.$el)},click:function(){qst.speedScrollTop()},mouseover:function(){this.hidden=!1,clearInterval(this.inrvl),this.$el.stop(!0,!0).fadeIn(200)},smartShow:function(a){return 2*a.w_h>a.d_h?!1:(a.s_top>a.w_h?this.hidden&&this.show():this.hidden||this.hide(),void 0)},show:function(){this.hidden=!1,clearInterval(this.inrvl),this.$el.stop(!0,!0).fadeIn(200),this.inrvl=setTimeout(_.bind(this.hide,this),3500)},hide:function(){this.hidden=!0,clearInterval(this.inrvl),this.$el.stop(!0,!0).fadeOut(1e3)}});