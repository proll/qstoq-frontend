"undefined"==typeof console&&(this.console={log:function(){},error:function(){}}),window.qst=window.qst||{},window.qst=_.extend(window.qst,{language:_.getCookie("lang")||(navigator.language||navigator.systemLanguage||navigator.browserLanguage||navigator.userLanguage||"en").substr(0,2).toLowerCase(),root:"http://qstoq.me",l10n:{},preloadTemplates:function(){if(window.qst_dev){var a=[];return _.each(window.templates.files,function(b){var c=window.templates.path+"/"+b+"."+window.templates.ext;a.push($.get(c,function(a){qst.Templates.add(b,a)}))}),a}return[]},init:function(){"en"!==this.language&&"ru"!==this.language&&(this.language="en"),$.when.apply(this,this.preloadTemplates()).done(function(){qst.app=new qst.App({debug:!0}),Backbone.history.start({pushState:!0})}),$(document).on("click","a",function(a){if(a.metaKey||a.ctrlKey)return!0;var b=$(this);return b.attr("target")?!0:(a.stopPropagation(),a.preventDefault(),"event"==b.attr("type")?qst.trigger(b.attr("href")):(qst.app.router.context=b.data(),qst.app.router.navigate(b.attr("href"),{trigger:!0})),!1)})},log:function(a){console.log(a)},error:function(a){console.error(a)},navigate:function(a,b){b&&b.trigger===!1&&(qst.app.statistic.trackCurrentPageChange(),qst.app.trigger("need:meta:update")),qst.app.router.navigate(a,b)},is_needauth:function(){return qst.is_authed()?!1:(qst.trigger("auth:show"),!0)},is_authed:function(){return!!qst.user&&qst.user.is_auth()},authUrl:function(a){var b={};return qst.app&&qst.app.user.get("token")?(b={token:qst.app.user.get("token")},-1==a.indexOf("?")&&(a+="?"),a+_.map(b,function(a,b){return b+"="+a}).join("&")):a},warning:function(a,b){new qst.WarningView({content:qst.localize(a,b)})},localize:function(a,b){return Handlebars.helpers._(a,b).toString()},speedScrollTop:function(a,b){$("html, body").animate({scrollTop:a||0},b||300)},isLink:function(a){return!qst.isFile(a)},isFile:function(a){return a=a||"",-1!==a.indexOf("qstoq.me")}}),window.qst.Templates=window.qst.Templates||{},window.qst.Templates=_.extend(window.qst.Templates,{templates:{},compiled:{},add:function(a,b){this.templates[a]=b},get:function(a){if(window.qst_dev)return this.compiled[a]?this.templates[a]:this.templates[a]?(this.templates[a]=Handlebars.compile(this.templates[a]),this.compiled[a]=!0,this.templates[a]):(console.error("Can't find template \""+a+'"'),function(){return""});if(this.ptemplates){var b=this.ptemplates[a];return b?b:(console.error("Can't find template \""+a+'"'),function(){return""})}return console.error("Can't find templates at all"),function(){return""}}}),Backbone._sync=Backbone.sync,Backbone.sync=function(a,b,c){c=c||{};var d={};return c.userData?d={token:c.userData.token}:qst.app&&qst.app.user.get("uid")&&(d={token:qst.app.user.get("token")}),c.url=c.url||b.url&&_.result(b,"url"),c.url+=-1===c.url.indexOf("?")?"?":"&",c.url+=_.map(d,function(a,b){return b+"="+a}).join("&"),Backbone._sync(a,b,c)},$(document).ready(function(){_.extend(qst,Backbone.Events),qst.init()}),qst.LazyLoader=Backbone.Model.extend({onImageError:function(){this.trigger("load:error")},load:function(a){var b=a.find("img.lazy"),c=this;_.forEach(b,function(a){var b=$(a),d=b.data(),e=new Image;e.src=d.orig,e.onload=function(){if(b.parents(".load-bg").toggleClass("img-loaded",!0),d.scale){var a=this.width,c=this.height,e=d.width,f=d.height,g=a/e,h=c/f;g>h?b.css({width:e,height:"auto"}):b.css({width:"auto",height:f})}if(d.bg){var i={},j="cover",k=0,l=0;if(d.crop){var a=this.width,c=this.height,e=d.width,f=d.height,g=a/e,h=c/f;g>h?(j="cover",k=-Math.round((a/h-e)/2)):h>g&&(j="cover",l=-Math.round((c/g-f)/2)),i={"background-image":"url("+d.orig+")","background-position-x":k,"background-position-y":l,width:e,height:f}}else i={"background-image":"url("+d.orig+")"};b.css(i)}else b.attr("src",d.orig)},e.onerror=_.bind(c.onImageError,c)})}}),qst.Page=Backbone.Model.extend({initialize:function(a){a.template||this.trigger("error",{message:"Page must have a template"}),this.view=new qst.PageView({model:this,template:a.template}),this.view.on("render",function(){this.collection.trigger("render")}),this.get("view")&&(this.pageView=this.get("model")?new(qst[this.get("view")])({model:this.get("model")}):new(qst[this.get("view")])),this.get("model")&&(this.pageModel=new(qst[this.get("model")]))},render:function(){this.view&&this.view.render&&this.view.render()},remove:function(){this.view.remove()},enterDocument:function(){}}),qst.PageView=Backbone.View.extend({el:"#qst-container",template:"",renderedHtml:null,initialize:function(a){return a&&a.template?(this.template=qst.Templates.get(a.template),this.createDom(),void 0):(qst.error("Page must have a template"),void 0)},createDom:function(){},render:function(){if(this.renderedHtml)this.$el.append(this.renderedHtml);else{var a=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.template(this.model.toJSON()));this.trigger("page:preRender",a),this.$el.html(a)}$("body").attr("class","body__page-"+this.model.get("name")),this.model.enterDocument(),this.trigger("page:render",this.model),this.trigger("enterDocument",this.model)},remove:function(){console.log("page remove"),this.renderedHtml=this.$el.find(".page-"+this.model.get("name")).detach()}}),qst.PagesCollection=Backbone.Collection.extend({initialize:function(){},getPage:function(a){var b=this.find(function(b){return b.get("name")==a});return b||this.first()},havePage:function(a){return this.any(function(b){return b.get("name")==a})}}),qst.PopupView=Backbone.View.extend({template:"popups/popup",className:"popup",events:{"click .popup__previous":"previous","click .popup__close":"hide","click .popup__close-btn":"hide","click .popup__td":"bgClick"},options:{},defaults:{content:"","class":"",width:""},_rendered:!1,initialize:function(){this.template=qst.Templates.get(this.template),_.defaults(this.options,this.defaults),this.on("popup:show",function(){this.trigger("show")},this),this.on("popup:hide",function(){this.trigger("hide")},this)},render:function(){if(this._rendered)return this.$el;var a=this.options.content;return(_.isObject(a)||!a)&&(this.options.content="<div id='placeholder"+this.cid+"'>"),this.$el.append(this.template(this.options)),this.setContent(a),this._rendered=!0,this.$el.on("scroll.popup",function(a){var b=$(a.currentTarget),c=b.find(".popup__table");b.scrollTop()+150>=c.height()-b.height()&&qst.trigger("popupbottom:reached")}),this.$el},lockPage:function(){},unlockPage:function(){},bgClick:function(a){a&&a.target&&"popup__td"==a.target.className&&this.hide()},reactKeypress:function(a){if(27==a.keyCode){var b=$(a.srcElement);b.is(":input")||this.hide()}},showPopup:function(){var a=$(document.body);a.append(this.render()),this.lockPage(),this.trigger("popup:show"),$(document).on("keyup.popup",_.bind(this.reactKeypress,this))},hidePopup:function(){this.$el.off("scroll.popup"),this.$el.detach(),this.trigger("popup:hide"),$(document).off("keyup.popup")},show:function(){this.showPopup()},hide:function(){return this.hidePopup(),this.unlockPage(),!1},previous:function(){this.trigger("previous")},scroll:function(a){this.$el.animate({scrollTop:a},200)},setContent:function(a){a&&(this.options.content=a,this._rendered?this.$el.find(".popup__content").empty().append(a):this.$el.find("#placeholder"+this.cid).replaceWith(a))},setWidth:function(a){a&&(this.options.width=a,this.$el.find(".popup__inner").toggleClass().addClass("popup__inner").addClass("span"+a))}}),qst.WarningView=Backbone.View.extend({template:"popups/warning",className:"warning",events:{"click .warning__close":"close"},options:{content:":("},initialize:function(a){this.options=a,this.template=qst.Templates.get(this.template),this.popup_view=new qst.PopupView({"class":"warning-popup"}),this.popup_view.on("hide",this.clear,this),this.render()},render:function(){return this.$el.append(this.template(this.options)),this.popup_view.setContent(this.$el),this.popup_view.show(),this.$el},close:function(){return this.popup_view.hide(),!1},clear:function(){return this.popup_view.remove(),this.remove(),!1}}),qst.Confirm=Backbone.Model.extend({url:"/",defaults:{url:"/",data:{},method:"post",event:"",eventdata:"",content:"?",ok_title:"Ok",close_title:"Cancel",success_title:"Allset",error_title:"Something went wrong...",backreload:!1},initialize:function(a){a&&a.url&&(this.url=a.url),this.view=new qst.ConfirmView({model:this})},fetch:function(a){return a=a||{},a.type=this.get("method"),a.data=this.get("data"),a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),b.error?this.trigger("confirm:error"):(this.trigger("confirm:success"),this.get("event")&&(console.log(this.get("event"),this.get("eventdata")),this.get("eventdata")&&!_.isEmpty(_.toJSON(this.get("eventdata")))?qst.trigger(this.get("event"),_.toJSON(this.get("eventdata"))):qst.trigger(this.get("event"))))},error:function(){this.trigger("confirm:error")}}),qst.ConfirmView=Backbone.View.extend({template:"popups/confirm",className:"confirm",events:{"click .confirm__close":"close","click .confirm__ok":"confirm"},initialize:function(){this.template=qst.Templates.get(this.template),this.popup_view=new qst.PopupView({"class":"confirm-popup"}),this.model.on("load:start",this.confirmStart,this),this.model.on("confirm:success",this.confirmSuccess,this),this.model.on("confirm:error",this.confirmError,this),this.popup_view.on("hide",this.clear,this),this.render()},render:function(){return this.$el.append(this.template(this.model.toJSON())),this.popup_view.setContent(this.$el),this.popup_view.show(),this.$el},confirm:function(){return this.model.fetch(),!1},confirmStart:function(){return this.$el.toggleClass("confirm_loading",!0).toggleClass("confirm_success",!1).toggleClass("confirm_error",!1),!1},confirmSuccess:function(){return this.$el.toggleClass("confirm_loading",!1).toggleClass("confirm_success",!0).toggleClass("confirm_error",!1),this.model.get("backreload")&&setTimeout(_.bind(function(){qst.trigger("historyback:reload"),this.clear()},this),1e3),!1},confirmError:function(){return this.$el.toggleClass("confirm_loading",!1).toggleClass("confirm_success",!1).toggleClass("confirm_error",!0),setTimeout(_.bind(function(){this.$el.toggleClass("confirm_error",!1)},this),2500),!1},close:function(){return this.popup_view.hide(),!1},clear:function(){return this.popup_view.remove(),this.remove(),this.model.clear({silent:!0}),!1}}),qst.UserSettings=Backbone.Model.extend({url:"/v1/users/",defaults:{geo_position:null},fetch:function(a){return a=a||{},a.type="get",a.data=a.data||{token:_.getCookie("token")},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){var b=_.toJSON(b);b.success&&b.result.user?(this.set(b.result.user),this.trigger("usersettings:ready",b.result.user)):this.trigger("error",{description:"WHP/auth : check state ERROR after netcall!"})},error:function(){this.trigger("error",{description:"WHP/auth : check state ERROR self!"})},getGeoPosition:function(){this.get("geo_position")||(navigator.geolocation?navigator.geolocation.getCurrentPosition(_.bind(this.getGeoSuccess,this),_.bind(this.getGeoError,this)):error("not supported"))},getGeoSuccess:function(a){this.set("geo_position",a)},getGeoError:function(a){qst.error(a)}}),qst.User=Backbone.Model.extend({cookie_time:365,defaults:{status:"",uid:"",token:""},settings:null,initialize:function(){this.settings=new qst.UserSettings,this.settings.on("error",function(a){this.trigger("user:error",a)},this),this.on("change:token",function(){this.settings.fetch()},this),this.getSession(),qst.on("auth:success",this.setSession,this),qst.on("auth:clear",this.clearSession,this)},getSession:function(){var a=_.getCookie("uid"),b=_.getCookie("token");a&&b&&this.set({uid:a,token:b})},is_auth:function(){return!!this.get("token")},setSession:function(a){_.setCookie("uid",a.session.uid,this.cookie_time),_.setCookie("token",a.session.token,this.cookie_time),this.set(a.session)},clearSession:function(){_.clearCookie("uid"),_.clearCookie("token"),this.set({uid:"",token:""})}}),qst.Registration=Backbone.Model.extend({url:"/v1/users/",initialize:function(){},fetch:function(a){var b=this;this.set(a),$.ajax({type:"POST",url:_.toSafeUrl(this.url),dataType:"json",data:{email:a.login,password:a.password,name:a.name}}).success(function(a,c,d){b.success(a,c,d)}).error(function(a,c,d){b.error(a,c,d)})},success:function(a){var b=_.toJSON(a);b?(this.trigger("auth:success",{response:b.result,user:b.result.user,session:{token:b.result.token,uid:b.result.user.id}}),this.trigger("registration:success")):this.error(null,null,"unknown")},error:function(a,b,c){this.trigger("error",{description:c})}}),qst.Signin=Backbone.Model.extend({url:"/v1/auth",initialize:function(){},login:function(a){return this.fetch(a),!1},fetch:function(a){var b=this;$.ajax({type:"post",url:this.url,dataType:"json",data:{email:a.login,password:a.password}}).success(function(a,c,d){b.success(a,c,d)}).error(function(a,c,d){b.error(a,c,d)})},success:function(a){var b=_.toJSON(a);b?this.trigger("auth:success",{response:b.result,user:b.result.user,session:{token:b.result.token,uid:b.result.user.id}}):this.error(null,null,"unknown")},error:function(a,b,c){if(console.log(a,b,c),a.responseText){var d=_.toJSON(a.responseText);if(d&&d.error)return this.trigger("error",d.error),!0}return this.trigger("error",{}),!0}}),qst.TW=Backbone.Model.extend({url_token:"/api/auth/twitter/request_token/",url:"/api/auth/",inited:!1,req_count:0,req_max:5,curWind:null,loading:!1,oauth_token:0,initialize:function(){var a,b=document.getElementsByTagName("script")[0];document.getElementById("twitter-jssdk")||(a=document.createElement("script"),a.id="twitter-jssdk",$(a).load(function(){}),a.src="//platform.twitter.com/widgets.js",b.parentNode.insertBefore(a,b),this.inited=!0,this.on("error",function(a){console.error(a)},this),qst.is_authed()||(this.req_count=0,this.fetchToken()))},login:function(){return qst.log("login tw >"),this.loading||(this.curWind=_.openWindow2("Twitter auth",640,480),this.curWind.location.href="http://api.twitter.com/oauth/authorize?oauth_token="+this.oauth_token),!1},fetchToken:function(){this.req_count>this.req_max&&this.trigger("error",{description:"too many token request to "+this.url_token}),this.loading=!0;var a=this;$.ajax({type:"GET",url:_.toSafeUrl(this.url_token),dataType:"json"}).success(function(b,c,d){a.successToken(b,c,d)}).error(function(b,c,d){a.errorToken(b,c,d)})},successToken:function(a){var b=_.toJSON(a);this.req_count++,b.error?this.trigger("error",{description:"WHP/auth/TW : got error while getting twitter token = ["+b.error.code+"]"}):(this.oauth_token=b.oauth_token,this.loading=!1,qst.log("WHP/auth/TW : get twitter request token = ["+b.oauth_token+"]"),this.req_count=0)},errorToken:function(a,b){this.req_count++,this.trigger("error",{description:"WHP/auth/TW : error while logging in!"});var b=a.status;console.log(a),0==b?this.trigger("error",{description:"WHP/auth/TW : OFFLINE mode!"}):this.trigger("error",{description:"WHP/auth/TW : error while getting twitter request token! Status = ["+b+"] Tries = ["+this.req_count+"]"}),this.fetchToken()},fetch:function(a){qst.log("GET TW AUTH = ["+a.uid+" : "+a.token+" : "+a.secret+"]"),qst.log("WHP/auth/TW : get auth...");var b=this;$.ajax({type:"GET",url:_.toSafeUrl(this.url),dataType:"json",data:{social:"tw",access_token:a.token,access_token_secret:a.secret}}).success(function(a,c,d){b.success(a,c,d)}).error(function(a,c,d){b.error(a,c,d)})},success:function(a){var b=_.toJSON(a);b.error?"API_AuthFailed"==b.error.code?this.trigger("error",{description:"This account isn't linked with WeHeartPics"}):this.trigger("error",{description:"Something went wrong"}):this.trigger("auth:success",{response:b,user:b.user,session:{token:b.user.token,uid:b.user.id}})},error:function(){this.trigger("error",{description:"WHP/auth/TW : error while logging in!"})}}),qst.VK=Backbone.Model.extend({url:"/v1/auth/vk",inited:!1,wind:null,app_id:3836385,redirect_url:qst.root+"/go/close_vk.html",initialize:function(){},login:function(){return this.wind=_.openWindow2("VK auth",640,480),this.wind.location.href="http://oauth.vk.com/authorize?client_id="+this.app_id+"&scope=photos,offline&response_type=token&display=popup&redirect_uri="+this.redirect_url,!1},fetch:function(a){var b=this,c=this.url;qst.is_authed()&&(c=qst.authUrl(this.url)),$.ajax({type:"post",url:c,dataType:"json",data:{vkAccessToken:a.token,vkUserId:a.uid}}).success(function(a,c,d){b.success(a,c,d)}).error(function(a){b.error(a)})},success:function(a){var b=_.toJSON(a);b&&b.success?this.trigger("auth:success",{response:b.result,user:b.result.user,session:{token:b.result.token,uid:b.result.user.id}}):this.error()},error:function(){qst.log("WHP/auth/VK : error while logging in!"),this.trigger("error",{description:"Something went wrong"})}}),qst.FB=Backbone.Model.extend({url:"/v1/auth/fb",app_id:"137692866413480",inited:!1,access_token:null,access_uid:null,initialize:function(){$.getScript("//connect.facebook.net/en_US/all.js#xfbml=1",_.bind(function(){FB.init({appId:this.app_id,cookie:!0,status:!0,xfbml:!0,oauth:!1}),FB.Event.subscribe("edge.create",this.fbShareEvents),_.browser.opera&&(FB.XD._transport="postmessage",FB.XD.PostMessage.init()),FB.getLoginStatus(_.bind(function(a){a&&"connected"==a.status?qst.log("Facebook : user was succesfully connected! :)"):qst.log("Facebook : user was not connected! :("),qst.fbapp&&!qst.is_authed()&&this.onFBData(a)},this)),this.inited=!0},this))},fetch:function(){if(null!=this.access_token){var a=this,b=this.url;qst.is_authed()&&(b=qst.authUrl(this.url)),$.ajax({type:"post",url:b,data:{fbUserId:this.access_uid,fbAccessToken:this.access_token},dataType:"json"}).success(function(b,c,d){a.success(b,c,d)}).error(function(b){a.error(b)})}},success:function(a){var b=_.toJSON(a);b&&b.success?this.trigger("auth:success",{response:b.result,user:b.result.user,session:{token:b.result.token,uid:b.result.user.id}}):this.error()},error:function(){qst.log("QST/auth/FB : error while logging in!"),this.trigger("error",{description:"QST/auth/FB : error while logging in!"})},login:function(){return this.access_token="",FB.login(_.bind(this.onFBData,this),{scope:"publish_actions,publish_stream,user_photos,offline_access,email"}),!1},loginOG:function(a,b){this.access_token="",FB.login(b,{scope:"publish_actions,publish_stream,user_photos,offline_access,email,user_birthday"})},fbShareEvents:function(a){qst.log("CreateEdge"),this.trigger("fb:like",a)},onFBData:function(a){if("connected"==a.status){qst.log("Facebook : user was succesfully connected! :)",a.authResponse);var b=a.authResponse.userID,c=a.authResponse.accessToken;this.access_token!=c?(qst.log("Facebook : token = ["+c+"]"),this.access_uid=b,this.access_token=c,this.fetch()):qst.log("Facebook : user was not connected! :(")}}}),qst.AuthView=Backbone.View.extend({template:"popups/auth",rendered:!1,className:"auth",events:{"click .auth__sign-toggler-lnk":"toggleSign","click .auth__social-item-lnk_vk":"loginVK","click .auth__social-item-lnk_fb":"loginFB",keypress:"hideErrors",click:"hideErrors","submit .auth__sign-form":"submit","click .auth__sign-submit-a":"submitForm"},initialize:function(){this.template=qst.Templates.get(this.template),this.model.on("auth:show",this.render,this),this.model.on("auth:success",this.remove,this)},render:function(){this.rendered=!0,this.$el.append(this.template(this.model.toJSON())),this.popup_view=new qst.PopupView({"class":"auth-popup"}),this.popup_view.on("hide",this.remove,this),this.popup_view.setContent(this.$el),this.popup_view.show(),this.$cont=this.$el.find(".auth__cont"),this.$sign_toggler=this.$el.find(".auth__toggler"),this.$form=this.$el.find(".auth__sign-form"),this.$input_email=this.$form.find("input[name=login]"),this.$input_name=this.$form.find("input[name=fio]"),this.$input_password=this.$form.find("input[name=password]"),this.$submit_btn=this.$form.find(".auth__sign-submit-a"),this.$error=this.$form.find(".auth__sign-submit-error"),this.model.signin.on("error",this.errorSignin,this),this.model.registration.on("error",this.errorSignup,this),this.toggleSign(),this.$input_email.focus()},toggleSign:function(){return this.$input_email.focus(),"signin"===this.model.get("state")?(this.$el.toggleClass("signin",!1).toggleClass("signup",!0),this.$input_email.attr("tabindex",1).attr("autocomplete","off"),this.$input_name.attr("tabindex",2).attr("autocomplete","off"),this.$input_password.attr("tabindex",3).attr("autocomplete","off"),this.$submit_btn.attr("tabindex",4).attr("autocomplete","off"),this.model.set("state","signup")):(this.$el.toggleClass("signin",!0).toggleClass("signup",!1),this.$input_email.attr("tabindex",1).attr("autocomplete","on"),this.$input_name.removeAttr("tabindex").attr("autocomplete","on"),this.$input_password.attr("tabindex",2).attr("autocomplete","on"),this.$submit_btn.attr("tabindex",3).attr("autocomplete","on"),this.model.set("state","signin")),!1},submitForm:function(){return this.$form.submit(),!1},submit:function(a){a.preventDefault(),a.stopPropagation();var b=$.trim(this.$input_email.val()),c=$.trim(this.$input_name.val()),d=$.trim(this.$input_password.val());return"signin"===this.model.get("state")?_.isEmail(b)?b.length>50?this.showError(qst.localize("Too much","auth"),"email"):_.isEmpty(d)?this.showError(qst.localize("Do you have an empty password?","auth"),"password"):d.length>45?this.showError(qst.localize("Too much","auth"),"password"):this.model.signin.login({login:b,password:d}):this.showError(qst.localize("Doesn&#39;t look like a valid email","auth"),"email"):_.isEmail(b)?b.length>50?this.showError(qst.localize("Too much","auth"),"email"):_.isEmpty(c)?this.showError(qst.localize("Please enter your name","auth"),"name"):c.length>55?this.showError(qst.localize("Too much","auth"),"name"):_.isEmpty(d)?this.showError(qst.localize("Please use not an empty password","auth"),"password"):d.length>45?this.showError(qst.localize("Too much","auth"),"password"):this.model.registration.fetch({login:b,password:d,name:c}):this.showError(qst.localize("Doesn&#39;t look like a valid email","auth"),"email"),!1},errorSignin:function(a){401===a.status?this.showError(qst.localize("Wrong e-mail and password combination :(","auth"),"email"):this.showError(qst.localize("Something went wrong...","misc"),"email")},errorSignup:function(a){401===a.status?this.showError(qst.localize("Wrong e-mail and password combination :(","auth"),"email"):this.showError(qst.localize("Something went wrong...","misc"),"email")},showError:function(a,b){switch(this.$error.html(a),this.$el.toggleClass("error",!0),b){case"email":this.$input_email.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_email.focus();break;case"name":this.$input_name.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_name.focus();break;case"password":this.$input_password.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_password.focus()}},hideErrors:function(){this.$el.toggleClass("error",!1),this.$el.find(".error-inp").toggleClass("error-inp",!1)},clear:function(){this.hideErrors(),this.$input_email.val(""),this.$input_name.val(""),this.$input_password.val("")},loginFB:function(){return this.model.FB.login(event),!1},loginTW:function(){return this.model.TW.login(event),!1},loginVK:function(){return this.model.VK.login(event),!1},remove:function(a){return this.model.off(null,null,this),this.model.signin.off(null,null,this),this.model.registration.off(null,null,this),this.popup_view.unlockPage(),this.popup_view.remove(),delete this.popup_view,Backbone.View.prototype.remove.call(this,a)}}),qst.Auth=Backbone.Model.extend({defaults:{state:"signup"},initialize:function(){this.FB=new qst.FB,this.VK=new qst.VK,this.signin=new qst.Signin,this.registration=new qst.Registration,this.on("vkontakte:hi",function(a){this.VK.fetch(a)},this),this.FB.on("auth:success",this.authSuccess,this),this.VK.on("auth:success",this.authSuccess,this),this.signin.on("auth:success",this.authSuccess,this),this.registration.on("auth:success",this.authSuccess,this),this.FB.on("error",this.error,this),this.VK.on("error",this.error,this),this.signin.on("error",this.error,this),this.registration.on("error",this.error,this),this.registration.on("registration:success",function(){qst.navigate("/",{trigger:!0})},this),qst.on("auth:show",function(a){return console.log("auth:show"),qst.is_authed()?(qst.navigate("/",{trigger:!0}),!1):(this.set("state","signup"),this.view=new qst.AuthView({model:this}),this.trigger("auth:show",a),void 0)},this),qst.on("navbar:logout",function(){this.logout()},this)},authSuccess:function(a){a.session&&this.trigger("auth:success",a)},logout:function(){this.trigger("auth:clear")},error:function(a){this.trigger("error",a)}}),qst.Config=function(){return{}},qst.Statistic=Backbone.Model.extend({url:"/api/photo/share/",yaCounter:null,gaCounter:null,initialize:function(){},trackCurrentPageChange:function(){return this.trackPageChange(window.location.pathname),!0},trackPageChange:function(a){var b=a.toString();"/"!=b.charAt(0)&&(b="/"+b),window._gaq&&window._gaq.push(["_trackPageview",b]),window.yaCounter22431070&&window.yaCounter22431070.hit(qst.root+b)},trackLike:function(){var a=_.getLS("qst_likec");_.isNaN(a)&&(a=0),a++,_.setLS("qst_likec",a,6e4)},trackComment:function(a){var b=_.getLS("qst_comc");_.isNaN(b)&&(b=0),b++,_.setLS("qst_comc",b,6e4);var c=1==a;c?window._gaq.push(["_trackEvent","Photo","reply"]):window._gaq.push(["_trackEvent","Photo","comment"])},trackShare:function(a){if("SHARE_FACEBOOK"==a){var b=_.getLS("qst_shrc");_.isNaN(b)&&(b=0),b++,_.setLS("qst_shrc",b,6e4)}window._gaq.push(["_trackEvent","Photo","share",a])},trackTimeline:function(a,b){var c="USER_TIMELINE_";a&&(c="MAIN_TIMELINE_"),window._gaq.push(["_trackEvent","Timeline","PagesLoaded",c+b,b])},trackNotifications:function(a){window._gaq.push(["_trackEvent","Notifications","PagesLoaded","PAGES_LOADED_"+a,a])},trackDownload:function(a){window._gaq.push(["_trackEvent","Download","click",a])},trackEmptyTimeline:function(a){var b="SHOW_TIMELINE_USER_EMPTY";a&&(b="SHOW_TIMELINE_MAIN_EMPTY"),window._gaq.push(["_trackEvent","Download","Views",b])},trackPhotoPlateShow:function(){window._gaq.push(["_trackEvent","Download","Views","SHOW_PHOTO_PAGE_PLATE"])},trackDownloadButtonMenu:function(a){var b="SHOW_DOWNLOAD_MENU_NEW";a||(b="SHOW_DOWNLOAD_MENU"),window._gaq.push(["_trackEvent","Download","Views",b])},trackEmptyStories:function(){window._gaq.push(["_trackEvent","Download","Views","SHOW_EMPTYSTORIES_DOWNLOAD"])},trackShowMainButton:function(){window._gaq.push(["_trackEvent","Download","Views","SHOW_MAIN_DOWNLOAD"])},trackXclick:function(){window._gaq.push(["_trackEvent","Download","Views","SHOW_CLICK_CLOSE_PLATE"])},trackShuffle:function(){var a=parseInt(_.getLS("qstsc"));_.isNaN(a)&&(a=0),a++,_.setLS("qstsc",a,1e3),window._gaq.push(["_trackEvent","Other","Shuffle","click",a])}}),qst.App=Backbone.Model.extend({_didScroll:!1,initialize:function(){this.$og_image=$("#og_image"),this.$og_url=$("#og_url");var a=this,b=window.qst;this.config=new b.Config,this.statistic=new b.Statistic,this.router=new b.Router,this.pages=new b.PagesCollection,this.user=new b.User,b.user=this.user,this.auth=new b.Auth,b.config=this.config,this.navbar=new b.Navbar,this.footer=new b.Footer,this.upscroller=new b.UpScrollerView,this.feedback=new b.Page({name:"feedback",template:"pages/feedback-page"}),this.pages.add(new b.Page({name:"404",template:"pages/404-page"})),this.pages.add(new b.Page({name:"403",template:"pages/403-page"})),this.itemlist=new b.ItemListPage({name:"itemlist",template:"pages/itemlist-page"}),this.pages.add(this.itemlist),this.landing=new b.LandingPage({name:"landing",template:"pages/landing-page"}),this.pages.add(this.landing),this.profile=new b.ProfilePage({name:"profile",template:"pages/profile-page"}),this.pages.add(this.profile),this.itemedit=new b.ItemEditPage({name:"itemedit",template:"pages/itemedit-page"}),this.pages.add(this.itemedit),this.paysystem=new b.PaySystemPage({name:"paysystem",template:"pages/paysystem-page"}),this.pages.add(this.paysystem),this.paysystemadd=new b.PaySystemAddPage({name:"paysystemadd",template:"pages/paysystemadd-page"}),this.pages.add(this.paysystemadd),this.router.on("404",function(){a.pages.getPage("404").render()}),this.router.on("route",function(a,c,d){switch(console.log("route:"+a),this.router.route_passed>1&&this.statistic.trackCurrentPageChange(),b.trigger("route",a,c,d),a){case"er404":this.pages.getPage("404").render();break;case"er403":this.pages.getPage("403").render();break;case"landing":b.is_authed()?b.navigate("/items",{trigger:!0}):this.landing.render();break;case"how":this.landing.render();break;case"where":this.landing.render();break;case"feedback":this.feedback.render();break;case"profile":c[0]||b.is_authed()?this.profile.render({section:c[0]?c[0]:"account"}):b.navigate("/",{trigger:!0});break;case"itemlist":b.is_authed()?this.itemlist.render():b.navigate("/403",{trigger:!0});break;case"itemedit":b.is_authed()?this.itemedit.render({id:c[0],section:c[1]?c[1]:"main"}):b.navigate("/",{trigger:!0});break;case"paysystem":b.is_authed()?this.paysystem.render({}):b.navigate("/",{trigger:!0});break;case"paysystemadd":b.is_authed()?this.router.route_passed<=1?b.navigate("/payments/",{trigger:!0}):this.paysystemadd.render({system:c[0],in_popup:!0}):b.navigate("/",{trigger:!0});break;default:c[0]&&!this.router.previousWasPopup()}this.trigger("need:meta:update")},this),this.router.on("reset",function(a,c){if(console.log(a,c),!this.router.isPopup(c))switch(this.router.isPopup(a)||b.speedScrollTop(0,1),a){case"landing":case"how":case"where":console.log("reset:landing"),this.landing.sleep();break;case"itemlist":console.log("reset:itemlist"),this.itemlist.sleep();break;case"profile":console.log("reset:profile"),this.profile.sleep();break;case"itemedit":console.log("reset:itemedit"),this.itemedit.sleep();break;case"paysystem":console.log("reset:paysystem"),this.paysystem.sleep();break;case"paysystemadd":console.log("reset:paysystemadd"),this.paysystemadd.sleep()}this.router.isPopup(a)&&_.forEach(this.pages.models,function(a){a.sleep&&a.get("name")!=c&&a.sleep()})},this),this.on("need:meta:update",function(){this.$og_url.attr("content",window.location.href)},this),b.on("historyback",function(){b.navigate(this.router.back_path,{trigger:!0})},this),b.on("historyback:reload",function(){b.trigger("historyback"),window.location.reload()},this),b.on("auth:clear",function(){b.navigate("/logout",{trigger:!0})}),b.on("link:delete",function(){b.navigate("/items",{trigger:!0})}),this.on("twitter:hi",function(a){this.auth.trigger("twitter:hi",a)},this),this.on("vkontakte:hi",function(a){this.auth.trigger("vkontakte:hi",a)},this),this.on("error",function(a){console.error("error"),a&&a.description&&b.error(a.description)}),this.auth.on("auth:success",function(a){b.trigger("auth:success",a),console.log(this.router.current_route),"profile"===this.router.current_route||"landing"!==this.router.current_route&&""!==this.router.current_route||b.navigate("/items",{trigger:!0})},this),this.auth.on("auth:clear",function(){b.trigger("auth:clear")},this),this.user.on("user:error",function(a){this.trigger("error",a),b.trigger("auth:clear")},this),this.user.on("session:checked",function(){b.trigger("session:checked"),console.log("session:checked")},this),this.user.settings.on("change:geo_position",function(a,c){b.trigger("geo_position:ready",c)},this),this.user.settings.on("usersettings:ready",function(a){b.trigger("usersettings:ready",a)},this),this.navbar.on("auth:show",function(){b.trigger("auth:show")},this),this.navbar.on("navbar:logout",function(){b.trigger("navbar:logout")},this);var c=$(window),d=$(document);$(window).scroll(function(){var a=c.scrollTop(),e=d.height(),f=c.height();
b.trigger("scroll",{s_top:a,d_h:e,w_h:f}),a+150>=e-f&&b.trigger("pagebottom:reached")}),b.is_authed()||this.navbar.show(),b.trigger("app:init")}}),qst.Router=Backbone.Router.extend({_previous_route:"",previous_route:"",previous_page_route:"",current_route:"",_back_path:"",back_path:"",route_passed:0,context:{},routes:{"":"landing","/":"landing",".":"landing",how:"how",where:"where",logout:"logout",items:"itemlist",profile:"profile","profile/:slide":"profile","profile/:slide/":"profile","item/:id":"itemedit","item/:id/:slide":"itemedit","item/:id/:slide/":"itemedit",feedback:"feedback","feedback/":"feedback","feedback/*":"feedback",payments:"paysystem","payments/":"paysystem","payments/add/:system":"paysystemadd","payments/add/:system/":"paysystemadd",404:"er404",403:"er403","*default":"er404"},popoup_routes:["auth","paysystemadd"],logout:function(){localStorage.clear(),this.navigate("/"),window.location.reload()},er404:function(){return console.log("no such route ",arguments),this.trigger("404",arguments),!1},er403:function(){return console.log("access dinied route ",arguments),this.trigger("403",arguments),!1},initialize:function(){var a=_.uniq(_.values(this.routes));_(a).each(function(a){this.on("route:"+a,function(){this.route_passed++,this._previous_route&&this._previous_route!=a&&(this.trigger("reset",this._previous_route,a,this._back_path),this.trigger("reset:"+this._previous_route)),this._previous_route=a,this._back_path=Backbone.history.fragment},this)},this),this.on("reset",function(a,b,c){this.back_path=c,this.current_route=b,this.previous_route=a,this.isPopup(this.previous_route)||(this.previous_page_route=this.previous_route)})},previousWasPopup:function(){return this.isPopup(this.previous_route)},currentIsPopup:function(){return this.isPopup(this.current_route)},isPopup:function(a){return-1!==_.indexOf(this.popoup_routes,a)}}),qst.Navbar=Backbone.Model.extend({defaults:{user:null,currentItem:"photofeed"},initialize:function(){this.view=new qst.NavbarView({model:this}),qst.on("route",function(a){this.set("currentItem",a)},this)},show:function(){this.view.show()}}),qst.NavbarView=Backbone.View.extend({template:"blocks/navbar",el:".navbar-header",_navItemPrefix:"nav__",events:{"click .nav__login>a":"login","click .nav__logout>a":"logout"},initialize:function(){this.template=qst.Templates.get(this.template),this.render(),this.model.on("change:currentItem",this.changeItem,this),qst.on("usersettings:ready",this.toggleAuth,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.$balance=this.$el.find(".nav__balance-title")},show:function(){this.$el.toggleClass("navbar_hidden",!1)},toggleAuth:function(a){this.show(),this.$balance&&0!=a.balance&&this.$balance.html(a.balance+"&nbsp;"+qst.localize(a.currency,"currency")),this.$el.toggleClass("logged",!0)},changeItem:function(a){var b=a.get("currentItem");this.$el.find(".nav li").toggleClass("active",!1),this.$el.find(".nav li."+this._navItemPrefix+b).toggleClass("active",!0)},login:function(){return this.model.trigger("auth:show"),!1},logout:function(){return this.model.trigger("navbar:logout"),!1}}),qst.Header=Backbone.Model.extend({defaults:{items:{},currentItem:"defaults"},initialize:function(){this.set("items",Handlebars.helpers._("items","header").string),this.view=new qst.HeaderView({model:this}),qst.on("route",this.changeItem,this)},changeItem:function(a){return qst.app.router.currentIsPopup()?!1:(this.get("items")[a]?this.set("currentItem",a):this.set("currentItem","defaults"),void 0)}}),qst.HeaderView=Backbone.View.extend({template:"blocks/header",el:".page-header",initialize:function(){this.template=qst.Templates.get(this.template),this.render(),this.model.on("change:currentItem",this.render,this)},render:function(){var a=this.template(this.model.get("items")[this.model.get("currentItem")]);"defaults"===this.model.get("currentItem")?this.$el.toggleClass("hidden",!0):this.$el.toggleClass("hidden",!1),this.$el.html(a)}}),qst.Footer=Backbone.Model.extend({initialize:function(){this.view=new qst.FooterView({model:this})},toggleLang:function(a){return"ru"!=a&&"en"!=a?!1:(_.setCookie("lang",a),window.location.reload(),void 0)}}),qst.FooterView=Backbone.View.extend({template:"blocks/footer",el:"footer",events:{"click .footer__lang-item_ru":"toggleRULang","click .footer__lang-item_en":"toggleENLang"},initialize:function(){this.template=qst.Templates.get(this.template),this.render()},render:function(){var a=this.template({year:(new Date).getFullYear()});this.$el.html(a)},toggleRULang:function(){return this.model.toggleLang("ru"),!1},toggleENLang:function(){return this.model.toggleLang("en"),!1}}),qst.ItemListPage=qst.Page.extend({visited:!1,defaults:{sleeped:!0,total:0},initialize:function(a){a=a||{},qst.on("link:delete",this.decTotal,this)},needRerender:function(){return this.get("sleeped")},render:function(a){return qst.is_needauth()?!1:this.needRerender()?(a=a||{},this.visited?(a.user=qst.user.get("uid"),this.itemlist.set(a),this.view.render(),this.itemlist.activate(),this.view.addItemList(this.itemlist),this.view.addAddDialog(this.adddialog),this.adddialog.activate(),this.itemlist.reset(),this.set("sleeped",!1)):(this.visited=!0,this.view=new qst.ItemListPageView({model:this,template:"pages/itemlist-page"}),this.view.render(),a.user=qst.user.get("uid"),this.itemlist=new qst.ItemList(a),this.adddialog=new qst.AddDialog(a),this.adddialog.on("add:success",this.linkAdded,this),this.adddialog.on("add:error",this.error,this),this.itemlist.activate(),this.itemlist.on("load:success",this.loadList,this),this.view.addItemList(this.itemlist),this.view.addAddDialog(this.adddialog),this.adddialog.activate(),this.set("sleeped",!1)),void 0):!1},loadList:function(a){this.set("total",a.total),this.view.updateTotal(a.total)},decTotal:function(){if(this.get("total")>0){var a=this.get("total")-1;this.set("total",a),this.view.updateTotal(a)}},incTotal:function(){var a=this.get("total")+1;this.set("total",a),this.view.updateTotal(a)},linkAdded:function(a){_.isEmpty(a)||(this.itemlist.addMyBlock(a),this.incTotal())},error:function(){qst.warning(qst.localize("Something went wrong...","misc"))},sleep:function(){return this.get("sleeped")?!1:(this.set("sleeped",!0),this.itemlist&&this.itemlist.sleep(),this.adddialog&&this.adddialog.sleep(),void 0)}}),qst.ItemListPageView=qst.PageView.extend({$header:null,addAddDialog:function(a){this.$header_btn=this.$el.find(".itemlist-head__btn"),this.$header_btn.html(a.view.$el)},addItemList:function(a){this.$el.find(".itemlist-row").html(a.view.$el)},updateTotal:function(a){a>0?this.$el.toggleClass("empty",!1).toggleClass("not-empty",!0):this.$el.toggleClass("empty",!0).toggleClass("not-empty",!1),this.$header_cnt=this.$el.find(".itemlist-head__cnt"),a||(a=Handlebars.helpers._("No","item")),this.$header_cnt.html(a+" "+Handlebars.helpers._plural(a,"item"))}}),qst.ItemList=Backbone.Model.extend({collection:null,defaults:{user:0,offset:0,limit:15,loading:!1,sleeped:!1,scrollload:!0},initialize:function(){this.collection=new qst.LinkCollection,this.collection.on("load:success",function(a){this.trigger("load:success",a),this.set("offset",this.get("offset")+this.get("limit")),this.set("loading",!1)},this),this.collection.on("load:error",function(){console.error("photofeed:load:error"),this.set("loading",!1)},this),this.collection.on("load:start",function(){this.set("loading",!0)},this),this.collection.on("add",this.addBlock,this),this.collection.on("reset",this.resetBlocks,this),this.view=new qst.ItemListView({collection:this.collection,model:this}),this.on("needmore",this.needMore,this),qst.on("link:delete",this.deleteBlock,this),this.get("scrollload")&&qst.on("pagebottom:reached",function(){this.trigger("needmore")},this)},addMyBlock:function(a){var b=new qst.Link(a);this.addBlock(b),this.collection.add(b,{at:-1})},addBlock:function(a){a.toJSON(),a.fetch()},resetBlocks:function(a,b){_.each(b.previousModels,function(a){a.remove()}),this.collection.more=!0},needMore:function(){if(!this.get("loading")&&!this.get("sleeped")){var a=this.toJSON();delete a.loading,delete a.sleeped,delete a.scrollload,this.collection.fetch({data:a})}},deleteBlock:function(a){var b=a.id;this.get("offset")>0&&this.set("offset",this.get("offset")-1);var c=_.find(this.collection.models,function(a){return a.get("id")==b});c.delayedRemove()},reset:function(){return this.set("offset",this.defaults.offset),this.collection.reset(),this.trigger("needmore"),!1},activate:function(){this.set("offset",this.defaults.offset),this.set("sleeped",!1),this.trigger("needmore")},sleep:function(){this.set("sleeped",!0)}}),qst.ItemListView=Backbone.View.extend({tagName:"div",className:"itemlist",template:"blocks/itemlist",initialize:function(a){this.collection=a.collection,this.collection.on("add",this.addBlock,this),this.collection.on("load:start",this.showSpinner,this),this.collection.on("load:success",this.hideSpinner,this),this.collection.on("load:error",this.hideSpinner,this),this.$spinner=null,this.model=a.model,this.render()},render:function(){this.template=qst.Templates.get(this.template);var a=this.template(this.model.toJSON());this.$el.html(a),this.$cont=this.$el.find(".itemlist__table>tbody"),this.showSpinner()},addBlock:function(a,b,c){c&&-1===c.at?this.$cont.prepend(a.view.$el):this.$cont.append(a.view.$el)},showSpinner:function(){this.$spinner?this.$spinner.toggleClass("hidden",!1):this.$spinner=this.$el.find(".itemlist__spinner")},hideSpinner:function(){this.$spinner&&!this.collection.more&&this.$spinner.toggleClass("hidden",!0)}}),qst.Link=Backbone.Model.extend({url:"/v1/links/",defaults:{},initialize:function(){this.view=new qst.LinkView({model:this})},fetch:function(){this.set("url_short_path",this.get("url_short").split("http://")[1]),this.set("overall",this.get("price")*this.get("counter_ship")),this.view.render(),this.on("change:active",this.toggleActive,this)},toggleActive:function(){return options={},options.url=this.url+this.get("id"),options.type="post",options.data=options.data||{active:this.get("active")?1:0},Backbone.Model.prototype.fetch.call(this,options)},remove:function(){this.stopListening(),this.clear({silent:!0}),this.view.remove()},delayedRemove:function(){this.view.delayedRemove();var a=this;setTimeout(function(){a.remove()},300)}}),qst.LinkView=Backbone.View.extend({template:"blocks/link",tagName:"tr",className:"itemlist__link",events:{"click .qst__toggle-a":"toggle","click .link__link":"clickShortLink"},$vote:null,$caption:null,$location_name:null,$location_addr:null,$likers:null,$comments:null,initialize:function(){this.template=qst.Templates.get(this.template)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a)},toggle:function(a){return this.model.get("active")?(this.model.set("active",!1),$(a.currentTarget).parents(".link__toggle").toggleClass("on",!1).toggleClass("off",!0)):(this.model.set("active",!0),$(a.currentTarget).parents(".link__toggle").toggleClass("on",!0).toggleClass("off",!1)),!1},clickShortLink:function(a){$(a.currentTarget).find("input").select()},delayedRemove:function(){var a=this;this.$el.css({height:this.$el.outerHeight()}),setTimeout(function(){a.$el.toggleClass("removing",!0),a.$el.css({opacity:0,height:0})},50)}}),qst.LinkCollection=Backbone.Collection.extend({url:"/v1/links/",model:qst.Link,more:!0,parse:function(a){return a=_.toJSON(a),a.result&&a.result.items?(this.total=parseInt(a.result.totalmore),this.more=a.result.more,a.result.items?a.result.items:!1):void 0},fetch:function(a){return this.more?(a=a||{},a.type="get",a.update=!0,a.remove=!1,a.data=a.data||{offset:0,limit:30},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Collection.prototype.fetch.call(this,a)):void 0},success:function(a,b){b=_.toJSON(b),b.error?this.trigger("load:error"):this.trigger("load:success",{total:this.total})},error:function(){this.trigger("load:error")}}),qst.AddDialog=Backbone.Model.extend({url:"/v1/links/",defaults:{name:"название ссылки",url:"медиа для продажи",price:1e3,description:"",price_pwyw:0,active:1,user:"",state:"",sleeped:!1},initialize:function(){this.view=new qst.AddDialogView({model:this}),this.set("state","link")},fetch:function(a){var b=this.toJSON();return""===$.trim(b.description)&&delete b.description,""===$.trim(b.url)&&delete b.url,delete b.active,delete b.sleeped,delete b.state,delete b.user,a=a||{},a.type="post",a.data=a.data||b,a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),b.success?this.trigger("add:success",b.result):this.trigger("add:error")},error:function(){this.trigger("add:error")},upload:function(a){if(a){this.view.updateFileName(a.name);var b=this,c=new FormData;c.append("input_file",a);var d=new XMLHttpRequest;d.upload.addEventListener("progress",function(a){b.view.updateFileProcess(a.loaded/a.total)},!1),d.onreadystatechange=function(){if(4==d.readyState)if(200==d.status){var c=this.response;"string"==typeof c&&(c=$.parseJSON(c)),c.success?(b.view.updateFileProcess(1),b.set("url",c.result.data)):b.trigger("add:error")}else console.log(a.name+":"+"ERROR: "+d.readyState+":"+d.status)},d.open("POST","/v1/medias/?token="+qst.user.get("token"),!0),d.send(c)}},reset:function(){return!1},activate:function(){this.set("sleeped",!1)},sleep:function(){this.set("sleeped",!0)}}),qst.AddDialogView=Backbone.View.extend({template:"blocks/adddialog",tagName:"div",className:"adddialog",events:{"click a.adddialog__add":"showDialog","click a.item__types-item":"clickState","click .adddialog__header":"hideDialog","click .adddialog__submit-a":"submitForm","change #file_uploader":"upload",keypress:"hideErrors",click:"hideErrors","submit form":"submit"},initialize:function(){this.render(),this.model.on("add:success",this.hideDialog,this),this.model.on("change:sleeped",this.sleep,this),this.model.on("change:state",this.changeState,this),this.model.on("change:url",this.changeLink,this)},render:function(){this.template=qst.Templates.get(this.template);var a=this.template(this.model.toJSON());this.$el.append(a),this.$state_items=this.$el.find(".item__types-item"),this.$form=this.$el.find("form"),this.$input_name=this.$form.find("input[name=name]"),this.$input_price=this.$form.find("input[name=price]"),this.$input_link=this.$form.find("input[name=link]"),this.$input_file=this.$form.find("input[name=file]"),this.$input_file_title=this.$form.find(".itemedit__inp-file-title"),this.$input_file_process=this.$form.find(".itemedit__inp-file-process"),this.$error=this.$el.find(".adddialog__error"),this.delegateEvents(),$("html").on("click.adddialog",_.bind(this.clickOutside,this))},clickState:function(a){var b=$(a.target);return this.model.set("state",b.attr("href")),!1},changeState:function(a,b){this.$state_items.parent().toggleClass("active",!1),this.$state_items.filter(".item-"+b).parent().toggleClass("active",!0),this.$el.toggleClass("state-link",!1).toggleClass("state-file",!1).toggleClass("state-nothing",!1).toggleClass("state-"+b,!0),"file"===b?this.$input_link.attr("disabled","disabled"):this.$input_link.removeAttr("disabled")},showDialog:function(a){return a.stopPropagation(),this.$el.toggleClass("open",!0),this.$input_name.focus(),!1},clearDialog:function(){this.$input_name.val(""),this.$input_price.val(""),this.$input_link.val(""),this.$input_file.val(""),this.updateFileName(qst.localize("Drop or choose a file","itemlist")),this.updateFileProcess(0)},hideDialog:function(){this.clearDialog(),this.$el.toggleClass("open",!1)},clickOutside:function(a){$(a.target).parents(".adddialog").length||this.hideDialog()},submit:function(){var a=this.$input_name.val(),b=this.$input_price.val(),c=this.$input_link.val(),d=this.$input_file.val(),e=this.model.get("state");if(_.isEmpty(a))return this.showError(qst.localize("write some name of the item","itemlist"),"name"),!1;if(_.isEmpty(b)||_.isNaN(parseInt(b)))return this.showError(qst.localize("set price, please","itemlist"),"price"),!1;if("link"===e){if(_.isEmpty(c))return this.showError(qst.localize("set a link, please","itemlist"),"link"),!1;if(!_.isUrl(c))return this.showError(qst.localize("set a valid link, please","itemlist"),"link"),!1}else if("file"===e&&_.isEmpty(d))return this.showError(qst.localize("load some file, please","itemlist"),"file"),!1;var f=-1!==b.indexOf("+");return this.model.set({name:a,url:c,price:parseInt(b),price_pwyw:f+0}),this.model.fetch(),!1},showError:function(a,b){switch(this.$error.text(a),this.$el.toggleClass("error",!0),b){case"name":this.$input_name.parent().toggleClass("error-inp",!0),this.$input_name.focus();break;case"price":this.$input_price.parent().toggleClass("error-inp",!0),this.$input_price.focus();break;case"link":this.$input_link.parent().toggleClass("error-inp",!0),this.$input_link.focus();break;case"file":this.$input_file.parent().toggleClass("error-inp",!0)}},hideErrors:function(){this.$el.toggleClass("error",!1),this.$el.find(".error-inp").toggleClass("error-inp",!1)},submitForm:function(){return this.$form.submit(),!1},sleep:function(a,b){this.hideDialog(),b?(this.undelegateEvents(),$("html").off("click.adddialog")):(this.delegateEvents(),$("html").on("click.adddialog",_.bind(this.clickOutside,this)))},reset:function(){},remove:function(){this.undelegateEvents(),$("html").off("click.adddialog")},upload:function(a){var b=this;$.each(a.target.files,function(a,c){b.model.upload(c)})},updateFileName:function(a){this.$input_file_title.text(a)},updateFileProcess:function(a){this.$input_file_process.width(Math.round(100*a)+"%")},changeLink:function(a,b){this.$input_link.val(b)}}),qst.LandingPage=qst.Page.extend({visited:!1,defaults:{img_num:0,lang:"en"},initialize:function(a){this.set("lang",qst.language),a=a||{}},render:function(){this.visited?this.view.render():(this.visited=!0,this.view=new qst.LandingPageView({model:this,template:"pages/landing-page"}),this.view.render())},showAuth:function(){qst.trigger("auth:show")},sleep:function(){this.view&&this.view.sleep()}}),qst.LandingPageView=qst.PageView.extend({indent:60,$window:$(window),events:{"click .landing__start-a":"showAuth","click .landing__next-a":"goSection2"},render:function(){if(this.renderedHtml)this.$el.append(this.renderedHtml);else{var a=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.template(this.model.toJSON()));this.trigger("page:preRender",a),this.$el.html(a)}$("body").attr("class","body__page-"+this.model.get("name")),this.model.enterDocument(),this.trigger("page:render",this.model),this.trigger("enterDocument",this.model),this.$window.on("resize.landing.page",_.bind(this.repositionPage,this)),this.$sec1=this.$el.find(".landing-section1"),this.$sec2=this.$el.find(".landing-section2"),this.$sec3=this.$el.find(".landing-section3"),this.repositionPage(),this.$nav_how=$(".navbar__item-how>a"),this.$nav_where=$(".navbar__item-where>a"),this.$nav_how.on("click.landing",_.bind(this.goSection2,this)),this.$nav_where.on("click.landing",_.bind(this.goSection3,this)),this.delegateEvents()},repositionPage:function(){var a=0;$(window).width(),a=this.$window.innerHeight()-this.indent;var b=Math.max(a,600);this.$sec1.height(b),this.$sec2.css({"margin-top":b})},showAuth:function(){return this.model.showAuth(),!1},goSection2:function(){return $("html, body").animate({scrollTop:this.$sec2.offset().top-this.indent},780),!1},goSection3:function(){return $("html, body").animate({scrollTop:this.$sec3.offset().top-this.indent},780),!1},sleep:function(){this.$nav_how.off("click.landing"),this.$nav_where.off("click.landing"),this.$window.off("resize.landing.page"),this.undelegateEvents()}}),qst.ProfilePage=qst.Page.extend({visited:!1,defaults:{section:"account",sleeped:!0},initialize:function(a){a=a||{}},needRerender:function(){return this.get("sleeped")},render:function(a){return a.section||(a.section=this.defaults.section),this.set(a),this.needRerender(a)?(this.visited?(this.view.render(),this.menu.set(a),this.view.addMenu(this.menu),this.account.set(a),this.account.activate(),this.view.addAccount(this.account),this.set("sleeped",!1)):(this.visited=!0,this.view=new qst.ProfilePageView({model:this,template:"pages/profile-page"}),this.view.render(),this.menu=new qst.ProfileMenu(a),this.view.addMenu(this.menu),this.account=new qst.Account(a),this.account.activate(),this.view.addAccount(this.account),this.set("sleeped",!1)),void 0):!1},sleep:function(){return this.get("sleeped")?!1:(this.set("sleeped",!0),this.menu&&this.menu.sleep(),this.account&&this.account.sleep(),void 0)},error:function(){qst.warning(qst.localize("Something went wrong...","misc"))}}),qst.ProfilePageView=qst.PageView.extend({initialize:function(a){return a&&a.template?(this.template=qst.Templates.get(a.template),this.createDom(),this.model.on("change:section",this.changeSection,this),void 0):(qst.error("Page must have a template"),void 0)},render:function(){if(this.renderedHtml)this.$el.append(this.renderedHtml);else{var a=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.template(this.model.toJSON()));this.trigger("page:preRender",a),this.$el.html(a)}this.$cont=this.$el.find(">div>div"),$("body").attr("class","body__page-"+this.model.get("name")),this.model.enterDocument(),this.trigger("page:render",this.model),this.trigger("enterDocument",this.model)},changeSection:function(a,b){this.$cont&&this.$cont.removeAttr("class").addClass("page-profile_"+b)},addMenu:function(a){this.$el.find(".profile__menu-row").html(a.view.$el)},addAccount:function(a){this.$el.find(".profile__section-account-row").html(a.view.$el)}}),qst.ProfileMenu=Backbone.Model.extend({url:"",defaults:{id:0,section:"account"},initialize:function(){this.view=new qst.ProfileMenuView({model:this})},sleep:function(){}}),qst.ProfileMenuView=Backbone.View.extend({template:"blocks/profile-menu",className:"profile-menu",initialize:function(){this.template=qst.Templates.get(this.template),this.render()},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a)}}),qst.Account=Backbone.Model.extend({url:"/v1/users/",defaults:{sleeped:!0,user:0,user_obj:{}},initialize:function(){this.view=new qst.AccountView({model:this}),qst.on("auth:success",this.authUpdate,this)},fetch:function(a){return a=a||{},a.type="get",a.data=a.data||{},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),this.set("user_obj",b.result.user),this.trigger("load:success")},error:function(){this.trigger("account:error")},activate:function(){this.set("sleeped",!1),this.fetch(),this.view.activate()},sleep:function(){this.set("sleeped",!0)},reset:function(){return!1},vkConnect:function(){qst.app.auth.VK.login()},fbConnect:function(){qst.app.auth.FB.login()},authUpdate:function(a){console.log(a),this.activate()},remove:function(){this.view.reset(),this.view.remove(),this.stopListening(),this.clear({silent:!0})}}),qst.AccountView=Backbone.View.extend({template:"blocks/account",tagName:"div",className:"account",events:{"click .account__social-item-vk>.account__social-item__connect-btn":"vkConnect","click .account__social-item-fb>.account__social-item__connect-btn":"fbConnect"},initialize:function(a){a.template&&(this.template=a.template),this.template=qst.Templates.get(this.template),this.model.on("load:success",this.render,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.activate()},activate:function(){this.delegateEvents()},vkConnect:function(a){return a.preventDefault(),this.model.vkConnect(),!1},fbConnect:function(a){return a.preventDefault(),this.model.fbConnect(),!1},reset:function(){this.undelegateEvents(),this.$el.html("")}}),qst.UserInfo=Backbone.Model.extend({url:"/api/user/",defaults:{sleeped:!0,user_id:0,loading_follow:!1,user:0,fields:"id,name,first_name,last_name,followers_count,followings_count,photos_count,tw_name,photo,is_awesome,awesome_account,bio,fb_id,fb_name,vk_id,vk_name,tw_id,tw_name,background,follow",user_obj:{}},initialize:function(){var a="blocks/user-info";_.isPhone()&&(a="blocks/user-info_phone"),this.view=new qst.UserInfoView({template:a,model:this})},fetch:function(a){return a=a||{},a.type="post",a.data=a.data||{user:this.get("user"),fields:this.get("fields")},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},follow:function(){var a="";this.set("loading_follow",!0),this.get("user_obj").follow?(a="/api/friends/unfollow/",this.get("user_obj").follow=!1):(a="/api/friends/follow/",this.get("user_obj").follow=!0),$.ajax({url:qst.authUrl(a),type:"POST",data:{user:this.get("user_id")},success:_.bind(this.followSuccess,this)})},followSuccess:function(){this.set("loading_follow",!1)},saveBio:function(){$.ajax({url:qst.authUrl("/api/user/update/"),type:"POST",data:{bio:this.get("user_obj").bio}})},success:function(a,b){b=_.toJSON(b),this.set("user_obj",b.user),b.error?this.trigger("userinfo:error"):this.trigger("load:success")},error:function(){this.trigger("userinfo:error")},editBio:function(a){return this.get("user_obj").bio==a?!1:(this.get("user_obj").bio=a,this.saveBio(),!0)},reportUser:function(a){var b={};b.data={user:this.get("user_id")},a&&(a.url&&(b.url=a.url),a.content&&(b.content=a.content),a.ok&&(b.ok_title=a.ok),a.close&&(b.close_title=a.close),a.success&&(b.success_title=a.success),a.error&&(b.error_title=a.error)),new qst.Confirm(b)},activate:function(){this.set("loading_follow",!1),this.set("sleeped",!1),this.get("user_id")!=this.get("user")?(this.view.clear(),this.set("user_id",this.get("user")),this.fetch()):(this.view.clearAutoSize(),this.view.activate())},sleep:function(){this.set("loading_follow",!1),this.set("sleeped",!0),this.view.clearAutoSize()},reset:function(){return!1},remove:function(){this.view.reset(),this.view.remove(),this.stopListening(),this.clear({silent:!0})}}),qst.UserInfoView=Backbone.View.extend({template:"blocks/user-info",tagName:"div",className:"user-info",events:{"click .profile__interact-bio":"focusBio","click .profile__interact-message":"gotoMessage","click .profile__report-title":"reportUser","keypress .profile__bio-input":"inputBio","blur .profile__bio-input":"editBio","click .profile__follow-head":"follow"},initialize:function(a){a.template&&(this.template=a.template),this.template=qst.Templates.get(this.template),this.model.on("load:success",this.render,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.lazy_loader=new qst.LazyLoader,this.lazy_loader.load(this.$el),this.activate()},reportUser:function(){this.model.reportUser(this.$el.find(".profile__report-title").data())},gotoMessage:function(){qst.navigate("/dialogs/"+this.model.get("user_id")+"/",{trigger:!0})},follow:function(a){if(!this.model.get("loading_follow")){var b=$(a.currentTarget);b.toggleClass("followed"),this.model.follow()}},focusBio:function(){if(this.$input)if(this.model.get("user_obj").bio)this.$input.focus();else{var a=this;this.$el.find(".profile__bio").slideDown(200,function(){a.$input.focus()})}},editBio:function(){var a=$.trim(this.$input.val());this.model.editBio(a)},inputBio:function(a){return 13!==a.keyCode||a.altKey?void 0:(this.$input.blur(),this.editBio(),!1)},activate:function(){var a=this;this.delegateEvents(),this.model.get("mine")&&(this.$input=this.$el.find(".profile__bio-input"),this.$input.length&&(this.$input.autosize(),setTimeout(function(){a.$input.trigger("resize")},10)));var b=this.model.get("user_obj").name;b&&(this.$header=$("header h1"),this.$header.html(b));var c=this.model.get("user_obj").photos_count;c&&c>0&&(this.$explore_counter=$(".profile-explore__count"),this.$explore_counter.html(c))},clear:function(){this.$el.html(""),this.$header=$("header h1"),this.$header.html("")},clearAutoSize:function(){$(window).off("resize.texarea_autosize"),$(".autosizejs").remove()},reset:function(){delete this.lazy_loader,this.undelegateEvents(),this.$el.html("")}}),qst.PreviewUpload=Backbone.Model.extend({url:"/v1/medias/",defaults:{link_id:0,data:""},initialize:function(){this.view=new qst.PreviewUploadView({model:this})},"delete":function(){var a={};return a.url=this.url+this.get("id"),a.type="delete",a.data=a.data||{link_id:this.get("link_id")},a.success=_.bind(this.successDelete,this),a.error=_.bind(this.errorDelete,this),this.trigger("delete:start"),Backbone.Model.prototype.fetch.call(this,a)},successDelete:function(a,b){b=_.toJSON(b),b.success?this.trigger("delete:success"):this.trigger("delete:error")},errorDelete:function(){this.trigger("delete:error")},upload:function(a){if(a){var b=this,c=new FormData;c.append("input_file",a);var d=new XMLHttpRequest;d.upload.addEventListener("progress",function(a){b.view.updateFileProcess(a.loaded/a.total)},!1),d.onreadystatechange=function(){if(4==d.readyState)if(200==d.status){var c=this.response;"string"==typeof c&&(c=$.parseJSON(c)),c.success?(b.view.updateFileProcess(1),b.set(c.result)):b.trigger("add:error")}else console.log(a.name+":"+"ERROR: "+d.readyState+":"+d.status)};var e={token:qst.user.get("token"),link_id:this.get("link_id"),identifier:"preview_image"};d.open("POST",this.url+"?"+_.map(e,function(a,b){return b+"="+a}).join("&"),!0),d.send(c)}},activate:function(){this.set("sleeped",!1)},sleep:function(){this.set("sleeped",!0)}}),qst.PreviewUploadView=Backbone.View.extend({template:"blocks/preview-upload",className:"preview-upload",events:{"change #file_uploader_preview":"upload","click .preview-upload__delete":"delete"},initialize:function(){this.template=qst.Templates.get(this.template),this.model.on("change:sleeped",this.sleep,this),this.model.on("change:data",this.changeURL,this),this.model.on("delete:success",this.togglePreviewOff,this),this.render()},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.lazy_loader=new qst.LazyLoader,this.$img=this.$el.find(".preview-upload__img"),this.$input_file=this.$el.find("input[name=file_preview]"),this.$input_file_process=this.$el.find(".preview-upload__inp-file-process"),this.changeURL(this.model,this.model.get("data")),this.delegateEvents()},changeURL:function(a,b){b?(this.$img.attr("src","/images_static/empty.png"),this.$img.data("orig",b),this.lazy_loader.load(this.$el),this.togglePreviewOn()):this.togglePreviewOff()},togglePreviewOff:function(){this.$img&&this.$img.attr("src","/images_static/empty.png"),this.$el.toggleClass("empty",!0)},togglePreviewOn:function(){this.$el.toggleClass("empty",!1)},upload:function(a){var b=this;$.each(a.target.files,function(a,c){b.model.upload(c)})},"delete":function(){return this.model.set("data",""),this.model.delete(),!1},updateFileProcess:function(a){1===a&&(a=0),this.$input_file_process.width(Math.round(100*a)+"%")},sleep:function(a,b){b?(this.undelegateEvents(),this.togglePreviewOff()):this.delegateEvents()}}),qst.ItemEditMenu=Backbone.Model.extend({url:"",defaults:{id:0,section:"main"},initialize:function(){this.view=new qst.ItemEditMenuView({model:this})},sleep:function(){}}),qst.ItemEditMenuView=Backbone.View.extend({template:"blocks/itemedit-menu",className:"itemedit-menu",initialize:function(){this.template=qst.Templates.get(this.template),this.render(),this.model.on("change:id",this.render,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a)}}),qst.ItemEdit=Backbone.Model.extend({url:"/v1/links/",url_media:"/v1/medias/",preview:null,defaults:{state:"",filename:"",receipt_comment:""},initialize:function(){this.view=new qst.ItemEditView({model:this}),this.on("change:receipt_comment",this.saveReceipt,this)},deleteItem:function(){var a={url:"/v1/links/"+this.get("id"),method:"delete",content:qst.localize("Do you want to delete this item?","itemlist"),ok_title:qst.localize("Ok","itemlist"),close_title:qst.localize("Cancel","itemlist"),success_title:qst.localize("Item deleted.","itemlist"),error_title:qst.localize("Something went wrong...","itemlist"),event:"link:delete",eventdata:{id:this.get("id")}};
new qst.Confirm(a)},init:function(){var a=this.get("url");if(_.isEmpty(a))this.set("state","nothing");else if(parseInt(this.get("external")))this.set("state","link");else{this.set("state","file");var b=this.get("url"),c=b.split("/");b=c[c.length-1],this.set("filename",b)}var d=this.get("preview"),e=!1;_.forEach(d,function(a){"receipt_comment"===a.identifier&&(e=a)}),e&&e.data&&(this.set("receipt_comment_id",e.id),this.set("receipt_comment",e.data,{silent:!0})),this.set("price_pwyw",parseInt(this.get("price_pwyw"))),this.set("url_short_path",this.get("url_short").split("http://")[1])},initAfterRender:function(){var a={},b=this.get("preview"),c=!1;_.forEach(b,function(a){"preview_image"===a.identifier&&(c=a)}),a=c&&c.data?{link_id:this.get("id"),data:c.data,id:c.id}:{link_id:this.get("id")},this.preview=new qst.PreviewUpload(a),this.view.addPreviewUpload(this.preview)},fetch:function(a){return a=a||{},a.url=this.url+this.get("id"),a.type="get",a.data=a.data||{},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),this.set(b.result),b.success?(this.init(),this.trigger("load:success"),this.initAfterRender()):this.trigger("load:error")},error:function(){this.trigger("load:error")},upload:function(a){if(a){this.view.updateFileName(a.name);var b=this,c=new FormData;c.append("input_file",a);var d=new XMLHttpRequest;d.upload.addEventListener("progress",function(a){b.view.updateFileProcess(a.loaded/a.total)},!1),d.onreadystatechange=function(){if(4==d.readyState)if(200==d.status){var c=this.response;"string"==typeof c&&(c=$.parseJSON(c)),c.success?(b.view.updateFileProcess(1),b.set("url",c.result.data)):b.trigger("add:error")}else console.log(a.name+":"+"ERROR: "+d.readyState+":"+d.status)},d.open("POST",this.url_media+"?token="+qst.user.get("token"),!0),d.send(c)}},saveReceipt:function(a,b){return this.toJSON(),options={},$.trim(b)?(options.url=this.url_media+"?identifier=receipt_comment&link_id="+this.get("id"),options.type="post",options.data=options.data||{data:b}):(options.url=this.url_media+this.get("receipt_comment_id"),options.type="delete",options.data={}),options.success=_.bind(this.saveReceiptSuccess,this),options.error=_.bind(this.saveReceiptError,this),this.trigger("savereceipt:start"),Backbone.Model.prototype.fetch.call(this,options)},saveReceiptSuccess:function(a,b){b=_.toJSON(b),b.success?(b.result&&b.result.id&&this.set("receipt_comment_id",b.result.id),this.trigger("savereceipt:success")):this.trigger("savereceipt:error")},saveReceiptError:function(){this.trigger("savereceipt:error")},save:function(a){var b=this.toJSON();return a=a||{},a.url=this.url+this.get("id"),a.type="post",a.data=a.data||{active:b.active,name:b.name,description:b.description,url:b.url,price:b.price,price_pwyw:b.price_pwyw,ship_limit:b.ship_limit},a.success=_.bind(this.saveSuccess,this),a.error=_.bind(this.saveError,this),this.trigger("save:start"),Backbone.Model.prototype.fetch.call(this,a)},saveSuccess:function(a,b){b=_.toJSON(b),b.success?this.trigger("save:success"):this.trigger("save:error")},saveError:function(){this.trigger("save:error")},activate:function(){this.set("sleeped",!1)},sleep:function(){this.set("sleeped",!0),this.preview&&this.preview.sleep()}}),qst.ItemEditView=Backbone.View.extend({template:"blocks/itemedit",className:"itemedit",events:{"click a.item__types-item":"clickState","click .itemedit__submit-a":"submitForm","change #file_uploader":"upload",keypress:"hideErrors",click:"hideErrors","click .itemedit__delete-a":"deleteItem","submit form":"submit","click .itemedit__share-inp-cont":"clickShortLink","click .itemedit__share-btn, .showcase__share-itm-a, .finish__share-itm-a":"clickShare","change input[name=name]":"updateName","change input[name=price]":"updatePrice","change input[name=ship_limit]":"updateShipLimit","change textarea[name=description]":"updateDescription","click .finish__form-add-comment-a":"toggleOnReceiptComment","click .finish__form-receipt_desc-action_cancel>a":"cancelReceiptComment","click .finish__form-receipt_desc-action_save>a":"saveReceiptComment"},initialize:function(){this.template=qst.Templates.get(this.template),this.model.on("load:success",this.render,this),this.model.on("change:sleeped",this.sleep,this),this.model.on("change:state",this.changeState,this),this.model.on("change:url",this.changeLink,this),this.lazy_loader=new qst.LazyLoader,this.model.on("save:start",this.saveStart,this),this.model.on("save:success",this.saveSuccess,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.$state_items=this.$el.find(".item__types-item"),this.$form=this.$el.find("form"),this.$input_active=this.$form.find("input[name=active]"),this.$input_name=this.$form.find("input[name=name]"),this.$input_price=this.$form.find("input[name=price]"),this.$input_ship_limit=this.$form.find("input[name=ship_limit]"),this.$input_description=this.$form.find("textarea[name=description]"),this.$input_link=this.$form.find("input[name=link]"),this.$input_file=this.$form.find("input[name=file]"),this.$input_file_title=this.$form.find(".itemedit__inp-file-title"),this.$input_file_process=this.$form.find(".itemedit__inp-file-process"),this.$error=this.$el.find(".itemedit__error"),this.$showcase=this.$el.find(".showcase__form"),this.$showcase_img=this.$showcase.find(".showcase__form__img"),this.$receipt_comment=this.$el.find(".finish__form-desc"),this.$input_receipt_comment=this.$el.find(".finish__form-receipt_desc"),this.changeState(this.model,this.model.get("state"));var b=$.trim(this.model.get("receipt_comment"));b?this.$el.toggleClass("comment-editing",!1).toggleClass("comment-can-edit",!0).toggleClass("comment-can-add",!1):this.$el.toggleClass("comment-editing",!1).toggleClass("comment-can-edit",!1).toggleClass("comment-can-add",!0),this.delegateEvents()},clickState:function(a){var b=$(a.target);return this.model.set("state",b.attr("href")),!1},changeState:function(a,b){this.$state_items&&(this.$state_items.parent().toggleClass("active",!1),this.$state_items.filter(".item-"+b).parent().toggleClass("active",!0),this.$el.toggleClass("state-link",!1).toggleClass("state-file",!1).toggleClass("state-nothing",!1).toggleClass("state-"+b,!0),"file"===b?this.$input_link.attr("disabled","disabled"):this.$input_link.removeAttr("disabled"))},submit:function(){var a=this.$input_active.is(":checked"),b=$.trim(this.$input_name.val()),c=this.$input_price.val(),d=this.$input_ship_limit.val(),e=this.$input_link.val(),f=(this.$input_file.val(),$.trim(this.$input_description.val())),g=this.model.get("state");if(_.isEmpty(b))return this.showError(qst.localize("write some name of the item","itemlist"),"name"),!1;if(_.isEmpty(c)||_.isNaN(parseInt(c)))return this.showError(qst.localize("set price, please","itemlist"),"price"),!1;if(_.isEmpty(d)||_.isNaN(parseInt(d)))return this.showError(qst.localize("set ship limit, please","itemlist"),"ship_limit"),!1;if("link"===g){if(_.isEmpty(e))return this.showError(qst.localize("set a link, please","itemlist"),"link"),!1;if(!_.isUrl(e))return this.showError(qst.localize("set a valid link, please","itemlist"),"link"),!1}var h=-1!==c.indexOf("+");return this.model.set({active:a+0,name:b,url:e,description:f,price:parseInt(c),price_pwyw:h+0,ship_limit:parseInt(d)}),this.model.save(),!1},showError:function(a,b){switch(this.$error.text(a),this.$el.toggleClass("error",!0),b){case"name":this.$input_name.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_name.focus();break;case"price":this.$input_price.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_price.focus();break;case"link":this.$input_link.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_link.focus();break;case"file":this.$input_file.parents(".qst__inp-cont").toggleClass("error-inp",!0)}},hideErrors:function(){this.$el.toggleClass("error",!1),this.$el.find(".error-inp").toggleClass("error-inp",!1)},submitForm:function(){return this.$form.submit(),!1},clickShare:function(a){var b=$(a.currentTarget).attr("href"),c="http://api.addthis.com/oexchange/0.8/forward/"+b+"/offer?"+"url="+this.model.get("url_short")+"&title="+encodeURIComponent(this.model.get("name"))+"&description="+encodeURIComponent(this.model.get("description"))+"&pubid=prolll"+"&text="+encodeURIComponent(this.model.get("description"))+"&via=qstoq";return console.log(a,c),_.openWindow3(c,b,480,360),!1},clickShortLink:function(a){$(a.currentTarget).find("input").select()},upload:function(a){var b=this;$.each(a.target.files,function(a,c){b.model.upload(c)})},deleteItem:function(){return this.model.deleteItem(),!1},updateFileName:function(a){this.$input_file_title.text(a)},updateFileProcess:function(a){1==a&&(a=0),this.$input_file_process.width(Math.round(100*a)+"%")},changeLink:function(a,b){this.$input_link&&this.$input_link.val(b)},saveStart:function(){this.$el.toggleClass("saving",!0)},saveSuccess:function(){this.$el.toggleClass("saving",!1)},addPreviewUpload:function(a){a.on("change:data",this.updateShowcasePreview,this),this.updateShowcasePreview(a,a.get("data")),this.$el.find(".item__preview-upload-cont").html(a.view.$el)},updateName:function(a){var b=$(a.target).val();this.$el.find(".showcase__head-title").html("Qstoq &ndash; "+b),this.$el.find(".showcase__form-h").html(b),this.$el.find(".finish__form-h").html(b)},updatePrice:function(a){var b=parseInt($(a.target).val());b=b?Handlebars.helpers._number_format(b).toString():0,this.$el.find(".showcase__form-price-val").html(b),this.$el.find(".finish__form-price-val").html(b)},updateShipLimit:function(){},updateDescription:function(a){var b=$(a.target).val();this.$el.find(".showcase__form-desc").html(b)},updateShowcasePreview:function(a,b){b?(this.$showcase_img.data("orig",b),this.lazy_loader.load(this.$showcase),this.togglePreviewOn()):this.togglePreviewOff()},togglePreviewOff:function(){this.$showcase_img&&this.$showcase_img.attr("src","/images_static/empty.png"),this.$showcase.toggleClass("empty",!0)},togglePreviewOn:function(){this.$showcase.toggleClass("empty",!1)},toggleOnReceiptComment:function(){return this.$el.toggleClass("comment-editing",!0).toggleClass("comment-can-edit",!1).toggleClass("comment-can-add",!1),this.$input_receipt_comment.focus(),!1},toggleOffReceiptComment:function(){var a=$.trim(this.model.get("receipt_comment"));return a?this.$el.toggleClass("comment-editing",!1).toggleClass("comment-can-edit",!0).toggleClass("comment-can-add",!1):this.$el.toggleClass("comment-editing",!1).toggleClass("comment-can-edit",!1).toggleClass("comment-can-add",!0),!1},cancelReceiptComment:function(){return this.$input_receipt_comment.val(this.model.get("receipt_comment")),this.toggleOffReceiptComment(),!1},saveReceiptComment:function(){var a=$.trim(this.$input_receipt_comment.val());return this.model.set("receipt_comment",a),this.$receipt_comment.text(a),this.toggleOffReceiptComment(),!1},clear:function(){this.hideErrors(),this.$input_name.val(""),this.$input_link.val(""),this.$input_file_process.width(0)},sleep:function(a,b){b?(this.undelegateEvents(),this.clear()):this.delegateEvents()}}),qst.ItemEditPage=qst.Page.extend({visited:!1,defaults:{id:0,section:"main",sleeped:!0},url:"",initialize:function(a){a=a||{}},needRerender:function(a){return this.get("sleeped")||a.id!=this.get("id")},render:function(a){return a.section||(a.section=this.defaults.section),this.set(a),this.needRerender(a)?(this.visited?(this.view.render(),this.menu.set(a),this.itemedit.set(a),this.itemedit.fetch(),this.itemedit.activate(),this.view.addMenu(this.menu),this.view.addItemEdit(this.itemedit),this.set("sleeped",!1)):(this.visited=!0,this.view=new qst.ItemEditPageView({model:this,template:"pages/itemedit-page"}),this.view.render(),this.menu=new qst.ItemEditMenu(a),this.itemedit=new qst.ItemEdit(a),this.itemedit.fetch(),this.itemedit.activate(),this.itemedit.on("save:error savereceipt:error",this.error,this),this.view.addMenu(this.menu),this.view.addItemEdit(this.itemedit),this.set("sleeped",!1)),void 0):!1},sleep:function(){return this.get("sleeped")?!1:(this.set("sleeped",!0),this.menu&&this.menu.sleep(),this.itemedit&&this.itemedit.sleep(),void 0)},error:function(){qst.warning(qst.localize("Something went wrong...","misc"))}}),qst.ItemEditPageView=qst.PageView.extend({initialize:function(a){return a&&a.template?(this.template=qst.Templates.get(a.template),this.createDom(),this.model.on("change:section",this.changeSection,this),void 0):(qst.error("Page must have a template"),void 0)},render:function(){if(this.renderedHtml)this.$el.append(this.renderedHtml);else{var a=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.template(this.model.toJSON()));this.trigger("page:preRender",a),this.$el.html(a)}this.$cont=this.$el.find(">div>div"),$("body").attr("class","body__page-"+this.model.get("name")),this.model.enterDocument(),this.trigger("page:render",this.model),this.trigger("enterDocument",this.model)},changeSection:function(a,b){this.$cont&&this.$cont.removeAttr("class").addClass("page-itemedit_"+b)},addMenu:function(a){this.$el.find(".itemedit__menu-row").html(a.view.$el)},addItemEdit:function(a){this.$el.find(".itemedit__section-row").html(a.view.$el)}}),qst.PaySystemPage=qst.Page.extend({visited:!1,defaults:{sleeped:!0,total:0},initialize:function(){},needRerender:function(){return this.get("sleeped")},render:function(a){return qst.is_needauth()?!1:this.needRerender()?(a=a||{},this.visited?(a.user=qst.user.get("uid"),this.paysystem.set(a),this.view.render(),this.paysystem.activate(),this.view.addPaySystem(this.paysystem),this.paysystem.reset(),this.set("sleeped",!1)):(this.visited=!0,this.view=new qst.PaySystemPageView({model:this,template:"pages/paysystem-page"}),this.view.render(),a.user=qst.user.get("uid"),this.paysystem=new qst.PaySystem(a),this.paysystem.activate(),this.view.addPaySystem(this.paysystem),this.set("sleeped",!1)),void 0):!1},sleep:function(){return this.get("sleeped")?!1:(this.set("sleeped",!0),this.paysystem&&this.paysystem.sleep(),void 0)}}),qst.PaySystemPageView=qst.PageView.extend({addPaySystem:function(a){this.$el.find(".paysystem-row").html(a.view.$el)}}),qst.PaySystem=Backbone.Model.extend({url:"/v1/links/",defaults:{user:0,loading:!1,sleeped:!1,paysys:["robokassa","assist","paymaster","paypal","webmoney","qiwi"],conf:[{key:"cards",icons:["mastercard","visa"],systems:["robokassa","assist","paymaster","paypal","webmoney","qiwi"]},{key:"phone",icons:["beeline","megafon","mts"],systems:["robokassa","assist","paymaster","paypal","webmoney","qiwi"]},{key:"qiwiw",icons:["qiwi"],systems:["robokassa","assist","paymaster","paypal","webmoney","qiwi"]},{key:"yd",icons:["yd"],systems:["robokassa","assist","paymaster","paypal","webmoney","qiwi"]},{key:"webmoney",icons:["webmoney"],systems:["robokassa","assist","paymaster","paypal","webmoney","qiwi"]},{key:"paypal",icons:["paypal"],systems:["robokassa","assist","paymaster","paypal","webmoney","qiwi"]}]},initialize:function(){this.on("load:success",function(){this.set("loading",!1)},this),this.on("load:error",function(){console.error("paysystem:load:error"),this.set("loading",!1)},this),this.view=new qst.PaySystemView({model:this})},reset:function(){return this.set("offset",this.defaults.offset),this.trigger("needmore"),!1},activate:function(){this.set("offset",this.defaults.offset),this.set("sleeped",!1),this.trigger("load:success")},sleep:function(){this.set("sleeped",!0)}}),qst.PaySystemView=Backbone.View.extend({template:"blocks/paysystem",className:"paysystem",events:{"click .paysystem__payment-way__select-val":"toggleDrop","change input":"changeDrop"},initialize:function(){this.template=qst.Templates.get(this.template),this.model.on("load:success",this.render,this),this.model.on("change:sleeped",this.sleep,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),$("html").on("click.paysystem",_.bind(this.hideDrop,this)),this.$dropdowns=this.$el.find(".paysystem__payment-way__select"),this.$showcase=this.$el.find(".showcase__form"),this.$showcase_img=this.$showcase.find(".showcase__form__img"),this.$receipt_comment=this.$el.find(".finish__form-desc"),this.$input_receipt_comment=this.$el.find(".finish__form-receipt_desc"),this.changeState(this.model,this.model.get("state"));var b=$.trim(this.model.get("receipt_comment"));b?this.$el.toggleClass("comment-editing",!1).toggleClass("comment-can-edit",!0).toggleClass("comment-can-add",!1):this.$el.toggleClass("comment-editing",!1).toggleClass("comment-can-edit",!1).toggleClass("comment-can-add",!0),this.delegateEvents()},toggleDrop:function(a){var b=$(a.target).parents(".paysystem__payment-way__select"),c=b.hasClass("open");this.hideDrop(),b.toggleClass("open",!c),a.stopPropagation()},hideDrop:function(){this.$dropdowns.toggleClass("open",!1)},changeDrop:function(a){var b=$(a.target),c=b.parents(".paysystem__payment-way__select"),d=b.siblings().filter(".option").html(),e=c.find(".paysystem__payment-way__select-val>.option");e.html(d)},clickState:function(a){var b=$(a.target);return this.model.set("state",b.attr("href")),!1},changeState:function(a,b){this.$state_items&&(this.$state_items.parent().toggleClass("active",!1),this.$state_items.filter(".item-"+b).parent().toggleClass("active",!0),this.$el.toggleClass("state-link",!1).toggleClass("state-file",!1).toggleClass("state-nothing",!1).toggleClass("state-"+b,!0),"file"===b?this.$input_link.attr("disabled","disabled"):this.$input_link.removeAttr("disabled"))},submit:function(){var a=this.$input_active.is(":checked"),b=$.trim(this.$input_name.val()),c=this.$input_price.val(),d=this.$input_ship_limit.val(),e=this.$input_link.val(),f=(this.$input_file.val(),$.trim(this.$input_description.val())),g=this.model.get("state");if(_.isEmpty(b))return this.showError(qst.localize("write some name of the item","itemlist"),"name"),!1;if(_.isEmpty(c)||_.isNaN(parseInt(c)))return this.showError(qst.localize("set price, please","itemlist"),"price"),!1;if(_.isEmpty(d)||_.isNaN(parseInt(d)))return this.showError(qst.localize("set ship limit, please","itemlist"),"ship_limit"),!1;if("link"===g){if(_.isEmpty(e))return this.showError(qst.localize("set a link, please","itemlist"),"link"),!1;if(!_.isUrl(e))return this.showError(qst.localize("set a valid link, please","itemlist"),"link"),!1}var h=-1!==c.indexOf("+");return this.model.set({active:a+0,name:b,url:e,description:f,price:parseInt(c),price_pwyw:h+0,ship_limit:parseInt(d)}),this.model.save(),!1},showError:function(a,b){switch(this.$error.text(a),this.$el.toggleClass("error",!0),b){case"name":this.$input_name.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_name.focus();break;case"price":this.$input_price.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_price.focus();break;case"link":this.$input_link.parents(".qst__inp-cont").toggleClass("error-inp",!0),this.$input_link.focus();break;case"file":this.$input_file.parents(".qst__inp-cont").toggleClass("error-inp",!0)}},hideErrors:function(){this.$el.toggleClass("error",!1),this.$el.find(".error-inp").toggleClass("error-inp",!1)},submitForm:function(){return this.$form.submit(),!1},clickShare:function(a){var b=$(a.currentTarget).attr("href"),c="http://api.addthis.com/oexchange/0.8/forward/"+b+"/offer?"+"url="+this.model.get("url_short")+"&title="+encodeURIComponent(this.model.get("name"))+"&description="+encodeURIComponent(this.model.get("description"))+"&pubid=prolll"+"&text="+encodeURIComponent(this.model.get("description"))+"&via=qstoq";return console.log(a,c),_.openWindow3(c,b,480,360),!1},clickShortLink:function(a){$(a.currentTarget).find("input").select()},upload:function(a){var b=this;$.each(a.target.files,function(a,c){b.model.upload(c)})},deleteItem:function(){return this.model.deleteItem(),!1},updateFileName:function(a){this.$input_file_title.text(a)},updateFileProcess:function(a){1==a&&(a=0),this.$input_file_process.width(Math.round(100*a)+"%")},changeLink:function(a,b){this.$input_link&&this.$input_link.val(b)},saveStart:function(){this.$el.toggleClass("saving",!0)},saveSuccess:function(){this.$el.toggleClass("saving",!1)},addPreviewUpload:function(a){a.on("change:data",this.updateShowcasePreview,this),this.updateShowcasePreview(a,a.get("data")),this.$el.find(".item__preview-upload-cont").html(a.view.$el)},updateName:function(a){var b=$(a.target).val();this.$el.find(".showcase__head-title").html("Qstoq &ndash; "+b),this.$el.find(".showcase__form-h").html(b),this.$el.find(".finish__form-h").html(b)},updatePrice:function(a){var b=parseInt($(a.target).val());b=b?Handlebars.helpers._number_format(b).toString():0,this.$el.find(".showcase__form-price-val").html(b),this.$el.find(".finish__form-price-val").html(b)},updateShipLimit:function(){},updateDescription:function(a){var b=$(a.target).val();this.$el.find(".showcase__form-desc").html(b)},updateShowcasePreview:function(a,b){b?(this.$showcase_img.data("orig",b),this.lazy_loader.load(this.$showcase),this.togglePreviewOn()):this.togglePreviewOff()},togglePreviewOff:function(){this.$showcase_img&&this.$showcase_img.attr("src","/images_static/empty.png"),this.$showcase.toggleClass("empty",!0)},togglePreviewOn:function(){this.$showcase.toggleClass("empty",!1)},toggleOnReceiptComment:function(){return this.$el.toggleClass("comment-editing",!0).toggleClass("comment-can-edit",!1).toggleClass("comment-can-add",!1),this.$input_receipt_comment.focus(),!1},toggleOffReceiptComment:function(){var a=$.trim(this.model.get("receipt_comment"));return a?this.$el.toggleClass("comment-editing",!1).toggleClass("comment-can-edit",!0).toggleClass("comment-can-add",!1):this.$el.toggleClass("comment-editing",!1).toggleClass("comment-can-edit",!1).toggleClass("comment-can-add",!0),!1},cancelReceiptComment:function(){return this.$input_receipt_comment.val(this.model.get("receipt_comment")),this.toggleOffReceiptComment(),!1},saveReceiptComment:function(){var a=$.trim(this.$input_receipt_comment.val());return this.model.set("receipt_comment",a),this.$receipt_comment.text(a),this.toggleOffReceiptComment(),!1},clear:function(){this.hideErrors()},sleep:function(a,b){$("html").off("click.paysystem"),b?(this.undelegateEvents(),this.clear()):this.delegateEvents()}}),qst.PaySystemAddPage=Backbone.Model.extend({visited:!1,defaults:{in_popup:!1,system:"qiwi"},initialize:function(){},render:function(a){this.set(a),this.visited=!0,a.in_popup=!!a.in_popup,this.view=new qst.PaySystemAddPageView({model:this,template:"pages/paysystemadd-page"}),this.view.render(a.in_popup,!1),this.paysystemadd=new qst.PaySystemAdd(a),this.view.addPaySystemAdd(this.paysystemadd),this.paysystemadd.activate({settings:qst.user.settings.toJSON()})},sleep:function(){this.remove()},remove:function(){this.off(),this.paysystemadd&&(this.paysystemadd.off(),this.paysystemadd.remove()),this.view&&(this.view.off(),this.view.remove())}}),qst.PaySystemAddPageView=qst.PageView.extend({template:"pages/paysystemadd-page",el:"body",is_popup:!1,addPaySystemAdd:function(a){this.$el.find(".paysystemadd-row").html(a.view.$el)},render:function(a){if(this.is_popup=a,this.popup_view=new qst.PopupView({"class":"paysystemadd-popup"}),this.popup_view.on("hide",function(){qst.trigger("historyback")},this),a)this.setElement("body"),this.renderedHtml?this.popup_view.setContent($(this.renderedHtml)):(this.renderedHtml=this.template(this.model.toJSON()),this.popup_view.setContent($(this.renderedHtml))),this.popup_view.show(),this.popup_view.$el.focus();else if(this.setElement("#qst-container"),this.renderedHtml)this.$el.append(this.renderedHtml);else{this.renderedHtml=this.template(this.model.toJSON());var b=$("<div></div>").addClass("page-"+this.model.get("name")).html(this.renderedHtml);this.trigger("page:preRender",b),this.$el.html(b)}this.trigger("page:render",this.model),this.trigger("enterDocument",this.model),this.delegateEvents()},remove:function(){this.model.off(null,null,this),this.undelegateEvents(),this.popup_view.unlockPage(),this.popup_view.remove()}}),qst.PaySystemAdd=Backbone.Model.extend({url:"/v1/users/link/",defaults:{system:"qiwi"},initialize:function(){this.view=new qst.PaySystemAddView({model:this})},activate:function(a){a&&this.set(a),this.view.render()},save:function(a){return a=a||{},a.url=this.url+this.get("system"),a.type="post",a.data=a.data||{},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("save:start"),Backbone.Model.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),this.set(b.result),b.success?this.trigger("save:success"):this.trigger("save:error")},error:function(){this.trigger("save:error")},remove:function(){this.stopListening(),this.clear({silent:!0}),this.view.remove()}}),qst.PaySystemAddView=Backbone.View.extend({template:"blocks/paysystemadd",events:{"submit .paysystemadd__form":"save","click .paysystemadd__form-submit-a":"clickToSubmit","change .qst__toggle__inp":"toggleActive",keypress:"hideErrors",click:"hideErrors"},$form:null,initialize:function(a){a.model&&(this.model=a.model),this.template=qst.Templates.get(this.template),this.model.on("save:start",this.toggleLoadingOn,this),this.model.on("save:success",this.toggleLoadingOff,this),this.model.on("save:error",this.toggleLoadingOff,this),this.model.on("save:error",this.errorSave,this)},render:function(){var a=this.template(this.model.toJSON());console.log(this.model.toJSON()),this.$el.html(a),this.$form=this.$el.find("."+this.model.get("system")+"-row").find(".paysystemadd__form"),this.$error=this.$el.find(".paysystemadd__form-submit-error"),this.$el.attr("class",this.model.get("system"))},clickToSubmit:function(a){a.stopPropagation(),a.preventDefault(),this.$form.submit()},toggleActive:function(a){var b=$(a.target),c=b.is(":checked");console.log(a),b.parent().toggleClass("on",c).toggleClass("off",!c)},toggleLoadingOff:function(){this.$el.toggleClass("loading",!1)},save:function(a){a.stopPropagation(),a.preventDefault(),this.hideErrors();var b=this.serialize(),c=this;if(_.isEmpty(b))c.showError(qst.localize("Please enter all attributes","paysystemadd"));else{var d=!1;_.forEach(b,function(a){a||0===a||(c.showError(qst.localize("Please enter all attributes","paysystemadd")),d=!0)}),d||c.model.save({data:b})}},serialize:function(){var a=this.$form.find("input"),b={};return a.each(function(a,c){var d=$(c);nm=d.data("name"),nm&&(b[nm]="checkbox"!==d.attr("type")?d.val():d.is(":checked")+0)}),b},errorSave:function(){this.showError(qst.localize("Something went wrong...","misc"))},showError:function(a){this.$error.html(a),this.$el.toggleClass("error",!0)},hideErrors:function(){this.$el.toggleClass("error",!1)}}),qst.UpScrollerView=Backbone.View.extend({tagName:"div",className:"up-scroller",inited:!1,inrvl:0,hidden:!0,events:{click:"click",mouseover:"mouseover",mouseout:"hide"},initialize:function(){this.inited||(this.inited=!0,this.render(),qst.on("scroll",this.smartShow,this))},render:function(){$("body").append(this.$el)},click:function(){qst.speedScrollTop()},mouseover:function(){this.hidden=!1,clearInterval(this.inrvl),this.$el.stop(!0,!0).fadeIn(200)},smartShow:function(a){return 2*a.w_h>a.d_h?!1:(a.s_top>a.w_h?this.hidden&&this.show():this.hidden||this.hide(),void 0)},show:function(){this.hidden=!1,clearInterval(this.inrvl),this.$el.stop(!0,!0).fadeIn(200),this.inrvl=setTimeout(_.bind(this.hide,this),3500)},hide:function(){this.hidden=!0,clearInterval(this.inrvl),this.$el.stop(!0,!0).fadeOut(1e3)}});